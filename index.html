<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiMANJA GOW - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Mobile-first approach: base styles are for mobile */
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; font-size: 14px; }
        .header-glass { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar-modern { background: #0f172a; border-right: 1px solid rgba(255, 255, 255, 0.1); }
        .card-base { 
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .card-base:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.3);
            border-color: rgba(219, 39, 119, 0.5);
        }
        .menu-item.active { background-color: rgba(219, 39, 119, 0.2); color: #f472b6; border-right: 3px solid #db2777; }
        .modal-content-custom { background-color: #1e293b; color: #e5e7eb; border: 1px solid rgba(255,255,255,0.1); max-height: 95vh; }
        .input-field-custom { background-color: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.2); color: #e5e7eb; padding: 0.5rem 0.75rem; border-radius: 0.5rem; width: 100%; font-size: 14px; }
        .input-field-custom:focus { background-color: #0f172a; border-color: #db2777; outline: none; box-shadow: 0 0 0 2px rgba(219, 39, 119, 0.5); }
        .action-btn { color: #cbd5e1; background-color: rgba(255,255,255,0.05); width: 2.25rem; height: 2.25rem; border-radius: 0.5rem; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; }
        .action-btn:hover { background-color: rgba(255,255,255,0.1); color: white; transform: scale(1.1); }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .btn-primary {
            background: linear-gradient(to right, #db2777, #c026d3);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px -5px rgba(219, 39, 119, 0.6);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px -5px rgba(219, 39, 119, 0.8);
        }
        
        .metric-card {
            border-radius: 0.75rem;
            color: white;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: block;
        }
        .metric-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .metric-card .icon {
            position: absolute;
            right: -1rem;
            bottom: -1rem;
            font-size: 4rem;
            opacity: 0.1;
            transition: transform 0.4s ease;
        }
        .metric-card:hover .icon {
            transform: rotate(-10deg) scale(1.1);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.5); /* slate-800 with 50% opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1rem; /* 16px */
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: float 6s ease-in-out infinite, neon-glow 2.5s ease-in-out infinite alternate;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        @keyframes neon-glow {
            from {
                box-shadow: 0 0 2px #db2777, 0 0 5px #db2777, 0 0 8px #db2777, 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            }
            to {
                box-shadow: 0 0 5px #c026d3, 0 0 12px #c026d3, 0 0 20px #c026d3, 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            }
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fade-in 0.8s ease-out forwards;
        }
        
        @media (min-width: 640px) {
            body { font-size: 16px; }
            .metric-card .icon { font-size: 5rem; }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-slate-900/50 backdrop-blur-md flex items-center justify-center p-4 z-[999] transition-opacity duration-1000 ease-in-out">
        <div class="w-full max-w-md text-center">
            <div class="glass-card p-8">
                 <img src="https://iili.io/FPZFHv9.png" alt="Logo SiMANJA GOW" class="h-20 mx-auto mb-4" onerror="this.src='https://placehold.co/200x80/1e293b/e5e7eb?text=SiMANJA+GOW'">
                 <h1 class="text-2xl font-bold text-white mb-2">SiMANJA GOW</h1>
                 <p class="text-slate-300 text-sm">Sistem Manajemen dan Jaringan Gabungan Organisasi Wanita Kabupaten Kepulauan Anambas</p>
                 <p class="text-slate-400 mt-4 text-xs">Memberdayakan Organisasi Wanita melalui platform terintegrasi untuk manajemen, kolaborasi, dan pertumbuhan.</p>
            </div>
        </div>
    </div>

    <div id="login-container" class="hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                 <img src="https://iili.io/FPZFHv9.png" alt="Logo SiMANJA GOW" class="h-20 mx-auto" onerror="this.src='https://placehold.co/200x80/1e293b/e5e7eb?text=SiMANJA+GOW'">
                 <p class="text-slate-400 mt-2 text-sm">Sistem Manajemen dan Jaringan Gabungan Organisasi Wanita Kabupaten Kepulauan Anambas</p>
            </div>
            <div class="card-base bg-slate-800 rounded-xl p-6 sm:p-8 relative">
                <button id="close-login-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div id="login-view">
                    <h2 class="text-xl sm:text-2xl font-bold text-center mb-6">Login</h2>
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-slate-300">Email</label>
                            <input type="email" id="login-email" class="input-field-custom mt-1" required>
                        </div>
                        <div>
                            <div class="flex justify-between items-center">
                                <label for="login-password" class="block text-sm font-medium text-slate-300">Password</label>
                                <button type="button" id="show-forgot-password" class="text-xs font-medium text-pink-400 hover:text-pink-300">Lupa Password?</button>
                            </div>
                            <div class="relative mt-1">
                                <input type="password" id="login-password" class="input-field-custom pr-10" required>
                                <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400" id="toggle-login-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="w-full btn-primary text-white font-bold py-2.5 px-4 rounded-lg">Masuk</button>
                    </form>
                    <p class="text-center text-xs sm:text-sm text-slate-400 mt-6">
                        Belum punya akun? <button id="show-register" class="font-medium text-pink-400 hover:text-pink-300">Daftar di sini</button>
                    </p>
                </div>
                <div id="register-view" class="hidden">
                    <h2 class="text-xl sm:text-2xl font-bold text-center mb-6">Daftar Akun Baru</h2>
                    <form id="register-form" class="space-y-4">
                        <div>
                            <label for="register-email" class="block text-sm font-medium text-slate-300">Email</label>
                            <input type="email" id="register-email" class="input-field-custom mt-1" required>
                        </div>
                        <div>
                            <label for="register-password" class="block text-sm font-medium text-slate-300">Password</label>
                            <div class="relative">
                                <input type="password" id="register-password" class="input-field-custom mt-1 pr-10" required>
                                <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400" id="toggle-register-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="w-full btn-primary text-white font-bold py-2.5 px-4 rounded-lg">Daftar</button>
                    </form>
                    <p class="text-center text-xs sm:text-sm text-slate-400 mt-6">
                        Sudah punya akun? <button id="show-login-from-register" class="font-medium text-pink-400 hover:text-pink-300">Login di sini</button>
                    </p>
                </div>
                 <div id="forgot-password-view" class="hidden">
                    <h2 class="text-xl sm:text-2xl font-bold text-center mb-2">Reset Password</h2>
                    <p class="text-center text-sm text-slate-400 mb-6">Masukkan email Anda untuk menerima link reset.</p>
                    <form id="forgot-password-form" class="space-y-4">
                        <div>
                            <label for="forgot-email" class="block text-sm font-medium text-slate-300">Email</label>
                            <input type="email" id="forgot-email" class="input-field-custom mt-1" required>
                        </div>
                        <button type="submit" class="w-full btn-primary text-white font-bold py-2.5 px-4 rounded-lg">Kirim Link Reset</button>
                    </form>
                    <p class="text-center text-xs sm:text-sm text-slate-400 mt-6">
                        Ingat password Anda? <button id="show-login-from-forgot" class="font-medium text-pink-400 hover:text-pink-300">Kembali ke Login</button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="flex h-screen overflow-hidden">
        <div id="sidebar" class="sidebar-modern text-white w-64 space-y-4 py-4 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 z-40 transition-all duration-300 flex flex-col">
            <div class="flex items-center justify-center w-full pt-2 pb-4">
                <img src="https://iili.io/FPZFHv9.png" alt="Logo SiMANJA GOW" class="h-16" onerror="this.src='https://placehold.co/150x64/0f172a/e5e7eb?text=SiMANJA+GOW'">
            </div>
            <button id="closeSidebar" class="md:hidden text-white hover:text-gray-300 transition-colors absolute top-4 right-4"><i class="fas fa-times text-sm"></i></button>
            <nav id="sidebar-nav" class="mt-2 space-y-1 flex-grow">
                <!-- Menu items will be dynamically generated here -->
            </nav>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="header-glass text-white">
                <div id="header-content" class="flex items-center justify-between p-3 sm:p-4">
                    <div class="flex items-center space-x-3">
                        <button id="openSidebar" class="md:hidden text-white"><i class="fas fa-bars text-lg"></i></button>
                        <div id="header-title-container">
                            <h2 id="headerTitle" class="text-lg sm:text-xl font-bold">Selamat Datang</h2>
                            <p class="text-xs text-white/80">Silakan login untuk melanjutkan</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                         <div id="user-info" class="hidden text-right">
                            <p id="user-email" class="text-xs sm:text-sm font-semibold truncate"></p>
                         </div>
                         <button id="show-login-btn" class="btn-primary text-white font-bold py-2 px-4 rounded-lg text-sm hidden">Login</button>
                         <button id="logout-btn" class="action-btn hidden" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto p-4 md:p-6" id="main-content"></main>
        </div>
    </div>

    <div id="modal-placeholder"></div>
    <div id="notification-placeholder"></div>
    
    <script type="module">
        // ===================================================================================
        // FIREBASE SETUP
        // ===================================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, getDocs, onSnapshot, 
            doc, deleteDoc, updateDoc, getDoc, query, where, setDoc,
            serverTimestamp, orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
            signInWithEmailAndPassword, signOut, sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const { jsPDF } = window.jspdf;

        const firebaseConfig = {
            apiKey: "AIzaSyAboBugSdtduTa4MIAeQXFkM8QHdah8lcQ",
            authDomain: "simanja-gow-app.firebaseapp.com",
            projectId: "simanja-gow-app",
            storageBucket: "simanja-gow-app.appspot.com",
            messagingSenderId: "307105555893",
            appId: "1:307105555893:web:e5470c451f5c4fdacea5fc"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const loginContainer = document.getElementById('login-container');
        const mainContent = document.getElementById('main-content');
        const headerTitleContainer = document.getElementById('header-title-container');
        const headerContent = document.getElementById('header-content');
        const userInfo = document.getElementById('user-info');
        const userEmailDisplay = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const showLoginBtn = document.getElementById('show-login-btn');
        const sidebarNav = document.getElementById('sidebar-nav');

        let activeListeners = [];
        let modalUnsubscribe = null;
        
        let currentUserRole = 'publik'; 
        let currentUserOrganisasi = null;
        let isAuthReady = false;

        let participationChartInstance = null;
        let proposalStatusChartInstance = null;
        
        // ===================================================================================
        // AUTHENTICATION LOGIC
        // ===================================================================================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    currentUserRole = userDoc.data().role || 'publik';
                    currentUserOrganisasi = userDoc.data().organisasiNama || null;
                } else {
                    await setDoc(doc(db, "users", user.uid), { email: user.email, role: 'publik' });
                    currentUserRole = 'publik';
                    currentUserOrganisasi = null;
                }

                loginContainer.classList.add('hidden');
                userInfo.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                showLoginBtn.classList.add('hidden');
                userEmailDisplay.textContent = user.email;

                renderSidebar(currentUserRole);

                if (!isAuthReady) {
                    isAuthReady = true;
                    navigate(window.location.hash || '#dashboard');
                } else {
                    navigate(window.location.hash || '#dashboard');
                }
            } else {
                // Not logged in, show login modal immediately
                currentUserRole = 'publik';
                currentUserOrganisasi = null;
                
                loginContainer.classList.remove('hidden');
                userInfo.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                showLoginBtn.classList.add('hidden'); // Hide header button when modal is open

                mainContent.innerHTML = '';
                headerTitleContainer.innerHTML = `<h2 id="headerTitle" class="text-lg sm:text-xl font-bold">Selamat Datang</h2>
                            <p class="text-xs text-white/80">Silakan login untuk melanjutkan</p>`;
                
                renderSidebar(currentUserRole);
                isAuthReady = true;
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                window.location.hash = '#dashboard';
                showNotification('Login berhasil!');
            } catch (error) {
                let friendlyMessage = "Terjadi kesalahan. Silakan coba lagi.";
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    friendlyMessage = "Email atau password yang Anda masukkan salah.";
                }
                showNotification(friendlyMessage, true);
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    email: userCredential.user.email,
                    role: "publik" 
                });
                showNotification('Akun berhasil dibuat! Silakan login.');
                showLoginView();
            } catch (error) {
                let friendlyMessage = "Gagal membuat akun.";
                if (error.code === 'auth/email-already-in-use') {
                    friendlyMessage = "Email ini sudah terdaftar. Silakan login.";
                } else if (error.code === 'auth/weak-password') {
                    friendlyMessage = "Password terlalu lemah. Gunakan minimal 6 karakter.";
                }
                showNotification(friendlyMessage, true);
            }
        });
        
        document.getElementById('forgot-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value;
            try {
                await sendPasswordResetEmail(auth, email);
                showNotification('Link reset password telah dikirim ke email Anda.');
                showLoginView();
            } catch (error) {
                showNotification(`Error: ${error.message}`, true);
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                 showNotification('Anda telah logout.');
            });
        });

        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const forgotPasswordView = document.getElementById('forgot-password-view');
        
        const showLoginView = () => {
            loginView.classList.remove('hidden');
            registerView.classList.add('hidden');
            forgotPasswordView.classList.add('hidden');
        };
        
        document.getElementById('show-register').addEventListener('click', () => {
            loginView.classList.add('hidden');
            registerView.classList.remove('hidden');
        });
        
        document.getElementById('show-forgot-password').addEventListener('click', () => {
            loginView.classList.add('hidden');
            forgotPasswordView.classList.remove('hidden');
        });

        document.getElementById('show-login-from-register').addEventListener('click', showLoginView);
        document.getElementById('show-login-from-forgot').addEventListener('click', showLoginView);
        
        showLoginBtn.addEventListener('click', () => {
            loginContainer.classList.remove('hidden');
            showLoginBtn.classList.add('hidden'); // Hide itself when modal opens
        });

        document.getElementById('close-login-btn').addEventListener('click', () => {
             loginContainer.classList.add('hidden');
             showLoginBtn.classList.remove('hidden'); // Show the header login button
        });

        const setupPasswordToggle = (toggleButtonId, passwordInputId) => {
            const toggleButton = document.getElementById(toggleButtonId);
            const passwordInput = document.getElementById(passwordInputId);
            const icon = toggleButton.querySelector('i');

            toggleButton.addEventListener('click', () => {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });
        };

        setupPasswordToggle('toggle-login-password', 'login-password');
        setupPasswordToggle('toggle-register-password', 'register-password');

        // ===================================================================================
        // UTILITY & MODAL FUNCTIONS
        // ===================================================================================
        const showNotification = (message, isError = false) => {
            const placeholder = document.getElementById('notification-placeholder');
            const id = `notif-${Date.now()}`;
            const bgColor = isError ? 'bg-red-600' : 'bg-green-600';

            const notificationEl = document.createElement('div');
            notificationEl.id = id;
            notificationEl.className = `fixed bottom-5 right-5 ${bgColor} text-white py-3 px-5 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[200]`;
            notificationEl.innerHTML = `<span>${message}</span>`;
            
            placeholder.appendChild(notificationEl);
            
            requestAnimationFrame(() => {
                notificationEl.classList.remove('translate-y-20', 'opacity-0');
            });

            setTimeout(() => {
                notificationEl.classList.add('opacity-0');
                setTimeout(() => {
                    notificationEl.remove();
                }, 300);
            }, 4000);
        };

        const createModal = (id, title, content, size = 'max-w-lg', zIndex = 100, onClose) => {
             if (id === 'manage-organisasi-modal' && modalUnsubscribe) {
                modalUnsubscribe();
                modalUnsubscribe = null;
            }

            const placeholder = document.getElementById('modal-placeholder');
            const modalContainer = document.createElement('div');
            modalContainer.id = id;
            modalContainer.className = `fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4`;
            modalContainer.style.zIndex = zIndex;
            modalContainer.innerHTML = `
                <div class="modal-content-custom rounded-xl shadow-2xl w-full ${size} transform scale-95 opacity-0 flex flex-col">
                    <div class="p-4 sm:p-5 border-b border-white/10 flex justify-between items-center flex-shrink-0">
                        <h3 class="text-lg font-bold">${title}</h3>
                        <button class="close-modal-btn w-8 h-8 rounded-full hover:bg-white/20"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-4 sm:p-6 overflow-y-auto">${content}</div>
                </div>`;
            placeholder.appendChild(modalContainer);
            const modalContent = modalContainer.querySelector('.modal-content-custom');
            setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 10);
            
            const closeModal = () => {
                if (id === 'manage-organisasi-modal' && modalUnsubscribe) {
                    modalUnsubscribe();
                    modalUnsubscribe = null;
                }
                if(onClose) onClose();
                modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => modalContainer.remove(), 300);
            };
            modalContainer.querySelector('.close-modal-btn').onclick = closeModal;
            modalContainer.onclick = (e) => { if (e.target === modalContainer) closeModal(); };
        };

        const showCustomConfirm = (title, message, onConfirm) => {
            const content = `
                <p class="text-gray-300 mb-6">${message}</p>
                <div class="flex justify-end gap-3">
                    <button id="confirm-cancel" class="bg-white/10 text-white px-4 py-2 rounded-lg">Batal</button>
                    <button id="confirm-ok" class="bg-red-600 text-white px-4 py-2 rounded-lg">Ya, Hapus</button>
                </div>`;
            createModal('confirm-modal', title, content, 'max-w-sm', 200);
            document.getElementById('confirm-ok').onclick = () => { onConfirm(); document.getElementById('confirm-modal')?.remove(); };
            document.getElementById('confirm-cancel').onclick = () => { document.getElementById('confirm-modal')?.remove(); };
        };

        // ===================================================================================
        // IMAGE COMPRESSION
        // ===================================================================================
        const compressImage = (file, maxWidth = 500) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onerror = error => reject(error);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(ctx.canvas.toDataURL('image/jpeg', 0.7)); // 70% quality
                    }
                }
            });
        };

        // ===================================================================================
        // CORE CRUD & DATA HANDLING
        // ===================================================================================
        const saveData = async (collectionName, id, formData) => {
            const rawData = Object.fromEntries(formData.entries());
            const processedData = {};

            for (const key in rawData) {
                if (key.includes('.')) {
                    const [parent, child] = key.split('.');
                    if (!processedData[parent]) {
                        processedData[parent] = {};
                    }
                    processedData[parent][child] = rawData[key];
                } else {
                    processedData[key] = rawData[key];
                }
            }

            try {
                if (id) {
                    processedData.updatedAt = serverTimestamp();
                    await updateDoc(doc(db, collectionName, id), processedData);
                    showNotification("Data berhasil diperbarui!");
                } else {
                    processedData.createdAt = serverTimestamp();
                    await addDoc(collection(db, collectionName), processedData);
                    showNotification("Data berhasil ditambahkan!");
                }
            } catch (e) {
                console.error("Gagal menyimpan dokumen: ", e);
                showNotification("Gagal menyimpan data. Periksa konfigurasi Firebase Anda.", true);
            }
        };

        const deleteData = (collectionName, id, displayName) => {
            showCustomConfirm('Hapus Data?', `Yakin ingin menghapus ${displayName}?`, async () => {
                try {
                    await deleteDoc(doc(db, collectionName, id));
                    showNotification("Data berhasil dihapus.");
                } catch (e) {
                    console.error("Gagal menghapus dokumen: ", e);
                    showNotification("Gagal menghapus data.", true);
                }
            });
        };

        // ===================================================================================
        // EXPORT FUNCTIONS
        // ===================================================================================
        const formatLahir = (data) => {
            const tempat = data.tempatLahir || '-';
            const tanggal = data.tanggalLahir ? new Date(data.tanggalLahir).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) : '-';
            return `${tempat}, ${tanggal}`;
        };

        const exportPengurusToPDF = async () => {
            showNotification('Mempersiapkan PDF Pengurus...');
            try {
                const q = query(collection(db, 'pengurus'), orderBy("createdAt", "asc"));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    showNotification('Tidak ada data pengurus untuk diekspor.', true);
                    return;
                }

                const allData = snapshot.docs.map(doc => doc.data());
                const pengurusInti = allData.filter(p => p.kategori === 'inti' || !p.kategori);
                const pengurusBidang = allData.filter(p => p.kategori === 'bidang');
                const bidangGrouped = pengurusBidang.reduce((acc, p) => {
                    const bidangName = p.namaBidang || 'Lainnya';
                    if (!acc[bidangName]) acc[bidangName] = [];
                    acc[bidangName].push(p);
                    return acc;
                }, {});

                const pdf = new jsPDF();
                pdf.text("Daftar Susunan Pengurus", 14, 16);
                let lastY = 22;
                const head = [['No', 'Nama Lengkap', 'Jabatan', 'Tempat/Tgl Lahir', 'Kontak', 'Alamat']];

                if (pengurusInti.length > 0) {
                    pdf.autoTable({
                        startY: lastY,
                        head: [['Pengurus Inti']],
                        body: [],
                        theme: 'plain',
                        headStyles: { fontStyle: 'bold', fontSize: 12, fillColor: false, textColor: 20 }
                    });
                    lastY = pdf.autoTable.previous.finalY + 2;

                    const tableData = pengurusInti.map((p, i) => [i + 1, p.nama || '-', p.jabatan || '-', formatLahir(p), p.kontak || '-', p.alamat || '-']);
                    pdf.autoTable({
                        startY: lastY,
                        head: head,
                        body: tableData,
                        theme: 'grid',
                        headStyles: { fillColor: [219, 39, 119] }
                    });
                    lastY = pdf.autoTable.previous.finalY + 10;
                }

                for (const [namaBidang, anggota] of Object.entries(bidangGrouped)) {
                    pdf.autoTable({
                        startY: lastY,
                        head: [[`Bidang: ${namaBidang}`]],
                        body: [],
                        theme: 'plain',
                        headStyles: { fontStyle: 'bold', fontSize: 12, fillColor: false, textColor: 20 }
                    });
                    lastY = pdf.autoTable.previous.finalY + 2;

                    const tableData = anggota.map((p, i) => [i + 1, p.nama || '-', p.jabatan || '-', formatLahir(p), p.kontak || '-', p.alamat || '-']);
                    pdf.autoTable({
                        startY: lastY,
                        head: head,
                        body: tableData,
                        theme: 'grid',
                        headStyles: { fillColor: [219, 39, 119] }
                    });
                    lastY = pdf.autoTable.previous.finalY + 10;
                }

                pdf.save('daftar-pengurus-lengkap.pdf');
            } catch (error) {
                console.error("Gagal mengekspor Pengurus ke PDF:", error);
                showNotification('Gagal membuat PDF Pengurus.', true);
            }
        };

        const exportAllOrganisasiToPDF = async () => {
            showNotification('Mempersiapkan PDF Organisasi...');
            try {
                const [orgSnapshot, anggotaSnapshot] = await Promise.all([
                    getDocs(query(collection(db, 'organisasi'), orderBy("createdAt", "asc"))),
                    getDocs(collection(db, 'anggota'))
                ]);

                if (orgSnapshot.empty) {
                    showNotification('Tidak ada data organisasi untuk diekspor.', true);
                    return;
                }
                
                const allAnggota = anggotaSnapshot.docs.map(doc => doc.data());
                const pdf = new jsPDF();
                pdf.text("Daftar Gabungan Organisasi Wanita (GOW)", 14, 16);

                const tableData = orgSnapshot.docs.map((doc, index) => {
                    const org = doc.data();
                    const anggotaCount = allAnggota.filter(a => a.organisasi === org.nama).length;
                    return [
                        index + 1,
                        org.nama || '-',
                        org.infoKetua?.nama || '-',
                        anggotaCount
                    ];
                });

                pdf.autoTable({
                    startY: 22,
                    head: [['No', 'Nama Organisasi', 'Nama Ketua', 'Jumlah Anggota']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [219, 39, 119] }
                });

                pdf.save('daftar-semua-organisasi.pdf');
            } catch (error) {
                console.error("Gagal mengekspor semua organisasi ke PDF:", error);
                showNotification('Gagal membuat PDF Organisasi.', true);
            }
        };

        const exportSpesifikOrganisasiToPDF = async (organisasiName) => {
            showNotification(`Mempersiapkan PDF untuk ${organisasiName}...`);
            try {
                const q = query(collection(db, 'anggota'), where("organisasi", "==", organisasiName));
                const anggotaSnapshot = await getDocs(q);

                if (anggotaSnapshot.empty) {
                    showNotification('Organisasi ini belum memiliki anggota.', true);
                    return;
                }

                const pdf = new jsPDF();
                pdf.text(`Daftar Anggota - ${organisasiName}`, 14, 16);
                
                const tableData = anggotaSnapshot.docs.map((doc, index) => {
                    const data = doc.data();
                    return [index + 1, data.nama || '-', data.jabatan || '-', formatLahir(data), data.kontak || '-', data.alamat || '-'];
                });

                pdf.autoTable({
                    startY: 22,
                    head: [['No', 'Nama Lengkap', 'Jabatan', 'Tempat/Tgl Lahir', 'Kontak', 'Alamat']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [219, 39, 119] }
                });

                pdf.save(`daftar-anggota-${organisasiName.replace(/\s+/g, '-')}.pdf`);

            } catch (error) {
                console.error("Gagal mengekspor organisasi spesifik ke PDF:", error);
                showNotification('Gagal membuat PDF.', true);
            }
        };
        
        const exportKegiatanToPDF = async () => {
            showNotification('Mempersiapkan PDF Kegiatan...');
            try {
                const q = query(collection(db, 'kegiatan'), orderBy("createdAt", "asc"));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    showNotification('Tidak ada data kegiatan untuk diekspor.', true);
                    return;
                }

                const pdf = new jsPDF();
                pdf.text("Daftar Kegiatan", 14, 16);
                
                const tableData = snapshot.docs.map((doc, index) => {
                    const data = doc.data();
                    return [index + 1, data.nama, data.tanggal, data.lokasi];
                });

                pdf.autoTable({
                    startY: 22,
                    head: [['No', 'Nama Kegiatan', 'Tanggal', 'Lokasi']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [219, 39, 119] }
                });

                pdf.save('daftar-kegiatan.pdf');
            } catch (error) {
                console.error("Gagal mengekspor kegiatan ke PDF:", error);
                showNotification('Gagal membuat PDF Kegiatan.', true);
            }
        };
        
        const exportUsulanToExcel = async () => {
            showNotification('Mempersiapkan file Excel...');
            try {
                const q = query(collection(db, 'usulanKegiatan'), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    showNotification('Tidak ada data usulan untuk diekspor.', true);
                    return;
                }

                const headers = [
                    "Nama Kegiatan", "Organisasi Pengusul", "Status", "Tanggal Pelaksanaan", 
                    "Lokasi", "Anggaran", "Sasaran", "Deskripsi", "Target Capaian", "Alasan Ditolak"
                ];

                const sanitizeCell = (cellData) => {
                    let cell = cellData ? String(cellData) : '';
                    if (cell.search(/("|,|\n)/g) >= 0) {
                        cell = `"${cell.replace(/"/g, '""')}"`;
                    }
                    return cell;
                };

                let csvContent = headers.join(',') + '\r\n';

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const row = [
                        sanitizeCell(data.namaKegiatan),
                        sanitizeCell(data.namaOrganisasi),
                        sanitizeCell(data.status),
                        sanitizeCell(data.tanggalPelaksanaan),
                        sanitizeCell(data.lokasiKegiatan),
                        data.anggaran || 0,
                        sanitizeCell(data.sasaranKegiatan),
                        sanitizeCell(data.deskripsi),
                        sanitizeCell(data.targetCapaian),
                        sanitizeCell(data.alasanDitolak)
                    ];
                    csvContent += row.join(',') + '\r\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", "usulan-kegiatan.csv");
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

            } catch (error) {
                console.error("Gagal mengekspor usulan ke Excel:", error);
                showNotification('Gagal membuat file Excel.', true);
            }
        };

        const exportUsulanToPDF = async () => {
            showNotification('Mempersiapkan PDF Usulan Kegiatan...');
            try {
                const q = query(collection(db, 'usulanKegiatan'), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    showNotification('Tidak ada data usulan untuk diekspor.', true);
                    return;
                }

                const pdf = new jsPDF({ orientation: "landscape" });
                pdf.text("Daftar Usulan Kegiatan", 14, 16);
                
                const tableData = snapshot.docs.map((doc, index) => {
                    const data = doc.data();
                    return [
                        index + 1,
                        data.namaKegiatan || '-',
                        data.namaOrganisasi || '-',
                        data.status || '-',
                        data.tanggalPelaksanaan || '-',
                        data.lokasiKegiatan || '-',
                        new Intl.NumberFormat('id-ID').format(data.anggaran || 0),
                        data.sasaranKegiatan || '-'
                    ];
                });

                pdf.autoTable({
                    startY: 22,
                    head: [['No', 'Nama Kegiatan', 'Organisasi', 'Status', 'Tanggal', 'Lokasi', 'Anggaran (Rp)', 'Sasaran']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [219, 39, 119] }
                });

                pdf.save('daftar-usulan-kegiatan.pdf');
            } catch (error) {
                console.error("Gagal mengekspor usulan ke PDF:", error);
                showNotification('Gagal membuat PDF Usulan.', true);
            }
        };

        // ===================================================================================
        // MODAL & PAGE DEFINITIONS
        // ===================================================================================

        const definitions = {
            pengurus: {
                title: 'Pengurus', collectionName: 'pengurus', photoField: 'foto',
                searchFields: ['nama', 'jabatan', 'namaBidang'],
                emptyMessage: '<i class="fas fa-user-slash text-4xl text-gray-500 mb-4"></i><h3 class="text-lg">Data Pengurus Kosong</h3>',
            },
            organisasi: {
                title: 'Organisasi', collectionName: 'organisasi',
                searchFields: ['nama', 'infoKetua.nama'],
                emptyMessage: '<i class="fas fa-sitemap text-4xl text-gray-500 mb-4"></i><h3 class="text-lg">Data Organisasi Kosong</h3>',
                renderCardFn: (o, anggotaCount) => {
                    const logo = o.logo 
                        ? `<img src="${o.logo}" class="w-16 h-16 rounded-lg object-cover flex-shrink-0" onerror="this.src='https://placehold.co/64x64/334155/e5e7eb?text=Logo'">` 
                        : `<div class="w-16 h-16 rounded-lg bg-black/20 flex items-center justify-center flex-shrink-0"><i class="fas fa-sitemap text-3xl"></i></div>`;
                    
                    const ketua = o.infoKetua || {};
                    const ketuaAvatar = ketua.foto 
                        ? `<img src="${ketua.foto}" class="w-12 h-12 rounded-full object-cover flex-shrink-0" onerror="this.src='https://placehold.co/48x48/ec4899/ffffff?text=${(ketua.nama || '?').charAt(0)}'"/>` 
                        : `<div class="w-12 h-12 rounded-full bg-pink-500 flex items-center justify-center text-lg flex-shrink-0">${(ketua.nama || '?').charAt(0)}</div>`;
                    
                    const adminButtons = `
                        <button data-action="edit-organisasi" data-id="${o.id}" class="action-btn" title="Edit Organisasi"><i class="fas fa-edit text-xs"></i></button>
                        <button data-action="delete" data-collection="organisasi" data-id="${o.id}" data-name="${o.nama}" class="action-btn" title="Hapus"><i class="fas fa-trash text-xs"></i></button>
                    `;

                    const exportSpesifikButton = `<button data-action="export-spesifik" data-name="${o.nama}" class="action-btn" title="Cetak Anggota"><i class="fas fa-print text-xs"></i></button>`;

                    const manageButtonHTML = () => {
                        if (currentUserRole === 'publik') return '';
                        const isOwner = currentUserRole === 'admin' || (currentUserRole === 'organisasi' && o.nama === currentUserOrganisasi);
                        const buttonTitle = isOwner ? 'Kelola Anggota' : 'Lihat Anggota';
                        const buttonIcon = 'fa-users';
                        return `<button data-action="manage-organisasi" data-id="${o.id}" class="action-btn" title="${buttonTitle}"><i class="fas ${buttonIcon} text-xs"></i></button>`;
                    };

                    return `
                    <div class="card-base rounded-xl p-4 bg-slate-800">
                        <div class="flex items-center justify-between space-x-3">
                            ${logo}
                            <div class="flex-1 min-w-0">
                                <h3 class="text-base sm:text-lg font-bold truncate">${o.nama}</h3>
                                <p class="text-sm text-pink-400 truncate">Ketua: ${ketua.nama || '-'}</p>
                                <p class="text-sm text-slate-400">Anggota: ${anggotaCount}</p>
                            </div>
                            ${ketuaAvatar}
                        </div>
                        <div class="border-t border-white/20 my-4"></div>
                        <div class="flex justify-end items-center">
                            <div class="flex space-x-1">
                                ${currentUserRole !== 'publik' ? `<button data-action="view-organisasi" data-id="${o.id}" class="action-btn" title="Lihat Detail"><i class="fas fa-eye text-xs"></i></button>` : ''}
                                ${manageButtonHTML()}
                                ${currentUserRole !== 'publik' ? exportSpesifikButton : ''}
                                ${currentUserRole === 'admin' ? adminButtons : ''}
                            </div>
                        </div>
                    </div>`;
                }
            },
            usulan: {
                title: 'Usulan Kegiatan', collectionName: 'usulanKegiatan',
                searchFields: ['namaKegiatan', 'namaOrganisasi', 'status'],
                emptyMessage: '<i class="fas fa-lightbulb text-4xl text-gray-500 mb-4"></i><h3 class="text-lg">Belum Ada Usulan Kegiatan</h3>',
                renderCardFn: (u) => {
                    const statusColors = {
                        'Diajukan': 'bg-yellow-500/20 text-yellow-400',
                        'Diverifikasi': 'bg-blue-500/20 text-blue-400',
                        'Disetujui': 'bg-green-500/20 text-green-400',
                        'Ditolak': 'bg-red-500/20 text-red-400',
                    };
                    const statusColor = statusColors[u.status] || 'bg-gray-500/20 text-gray-400';
                    const adminButtons = `
                        <button data-action="edit-usulan" data-id="${u.id}" class="action-btn" title="Edit"><i class="fas fa-edit text-xs"></i></button>
                        <button data-action="delete" data-collection="usulanKegiatan" data-id="${u.id}" data-name="${u.namaKegiatan}" class="action-btn" title="Hapus"><i class="fas fa-trash text-xs"></i></button>
                    `;
                    const orgButtons = `
                        <button data-action="edit-usulan" data-id="${u.id}" class="action-btn" title="Edit"><i class="fas fa-edit text-xs"></i></button>
                        <button data-action="delete" data-collection="usulanKegiatan" data-id="${u.id}" data-name="${u.namaKegiatan}" class="action-btn" title="Hapus"><i class="fas fa-trash text-xs"></i></button>
                    `;
                    return `
                    <div class="card-base rounded-xl p-4 bg-slate-800 flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start">
                                <div class="w-10 h-10 rounded-lg bg-pink-500/20 flex items-center justify-center"><i class="fas fa-lightbulb text-lg text-pink-400"></i></div>
                                <span class="text-xs font-medium ${statusColor} px-2 py-1 rounded-full">${u.status}</span>
                            </div>
                            <h3 class="text-base sm:text-md font-bold mt-4 leading-tight h-12 line-clamp-2">${u.namaKegiatan}</h3>
                            <p class="text-sm text-slate-400 mt-1"><i class="fas fa-sitemap mr-2"></i>${u.namaOrganisasi}</p>
                        </div>
                        <div class="border-t border-white/10 mt-4 pt-4 flex justify-end space-x-2">
                            <button data-action="view-usulan" data-id="${u.id}" class="action-btn" title="Lihat Detail"><i class="fas fa-eye text-xs"></i></button>
                            ${currentUserRole === 'admin' ? adminButtons : ''}
                            ${currentUserRole === 'organisasi' && u.namaOrganisasi === currentUserOrganisasi ? orgButtons : ''}
                        </div>
                    </div>`
                }
            },
            anggota: {
                title: 'Anggota', collectionName: 'anggota', photoField: 'foto',
                fields: [
                    { label: 'Nama Lengkap', name: 'nama', type: 'text', required: true },
                    { label: 'Jabatan', name: 'jabatan', type: 'text', required: true },
                    { label: 'Tempat Lahir', name: 'tempatLahir', type: 'text' },
                    { label: 'Tanggal Lahir', name: 'tanggalLahir', type: 'date' },
                    { label: 'Kontak', name: 'kontak', type: 'tel' },
                    { label: 'Alamat', name: 'alamat', type: 'textarea' },
                ]
            },
            dokumentasi: {
                title: 'Dokumen', collectionName: 'dokumentasi', fileUpload: true,
                searchFields: ['judul', 'kategori'],
                emptyMessage: '<i class="fas fa-file-excel text-4xl text-gray-500 mb-4"></i><h3 class="text-lg">Belum Ada Dokumen</h3>',
                fields: [
                    { label: 'Judul Dokumen', name: 'judul', type: 'text', required: true },
                    { label: 'Kategori', name: 'kategori', type: 'text', required: true },
                    { label: 'Tanggal', name: 'tanggal', type: 'date', required: true },
                    { label: 'Deskripsi', name: 'deskripsi', type: 'textarea' },
                    { name: 'file', type: 'hidden' },
                    { name: 'fileName', type: 'hidden' }
                ],
                renderCardFn: (d) => {
                    const adminButtons = `
                        <button data-action="edit-dokumentasi" data-id="${d.id}" class="action-btn" title="Edit"><i class="fas fa-edit text-xs"></i></button>
                        <button data-action="delete" data-collection="dokumentasi" data-id="${d.id}" data-name="${d.judul}" class="action-btn" title="Hapus"><i class="fas fa-trash text-xs"></i></button>
                    `;
                    return `
                    <div class="card-base rounded-xl p-4 bg-slate-800 flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start">
                                <div class="w-10 h-10 rounded-lg bg-pink-500/20 flex items-center justify-center"><i class="fas fa-file-alt text-lg text-pink-400"></i></div>
                                <span class="text-xs font-medium bg-slate-700 text-slate-300 px-2 py-1 rounded-full">${d.kategori}</span>
                            </div>
                            <h3 class="text-base sm:text-md font-bold mt-4 leading-tight h-12 line-clamp-2">${d.judul}</h3>
                            <p class="text-sm text-slate-400 mt-1"><i class="fas fa-calendar-alt mr-2"></i>${d.tanggal}</p>
                        </div>
                        <div class="border-t border-white/10 mt-4 pt-4 flex justify-end space-x-2">
                            <button data-action="view-dokumentasi" data-id="${d.id}" class="action-btn" title="Lihat Detail"><i class="fas fa-eye text-xs"></i></button>
                            ${currentUserRole !== 'publik' && d.file && d.fileName ? `<button data-action="download-dokumentasi" data-id="${d.id}" class="action-btn" title="Download"><i class="fas fa-download text-xs"></i></button>` : ''}
                            ${currentUserRole === 'admin' ? adminButtons : ''}
                        </div>
                    </div>`
                }
            },
            kegiatan: {
                title: 'Kegiatan', collectionName: 'kegiatan', photoField: 'foto',
                searchFields: ['nama', 'lokasi'],
                emptyMessage: '<i class="fas fa-calendar-times text-4xl text-gray-500 mb-4"></i><h3 class="text-lg">Belum Ada Kegiatan</h3>',
                fields: [
                    { label: 'Nama Kegiatan', name: 'nama', type: 'text', required: true },
                    { label: 'Lokasi', name: 'lokasi', type: 'text', required: true },
                    { label: 'Tanggal', name: 'tanggal', type: 'date', required: true },
                    { label: 'Deskripsi', name: 'deskripsi', type: 'textarea' },
                ],
                renderCardFn: (k) => {
                    const adminButtons = `
                        <button data-action="edit-kegiatan" data-id="${k.id}" class="action-btn" title="Edit"><i class="fas fa-edit text-xs"></i></button>
                        <button data-action="delete" data-collection="kegiatan" data-id="${k.id}" data-name="${k.nama}" class="action-btn" title="Hapus"><i class="fas fa-trash text-xs"></i></button>
                    `;
                    return `
                    <div class="card-base rounded-xl bg-slate-800 overflow-hidden flex flex-col">
                        <img src="${k.foto || 'https://placehold.co/600x400/334155/e5e7eb?text=Kegiatan'}" class="w-full h-32 sm:h-40 object-cover" onerror="this.src='https://placehold.co/600x400/334155/e5e7eb?text=Kegiatan'">
                        <div class="p-4 flex flex-col flex-grow">
                            <p class="text-xs text-slate-400 mb-2"><i class="fas fa-calendar-alt mr-2"></i>${k.tanggal}</p>
                            <h3 class="text-base sm:text-md font-bold leading-tight flex-grow line-clamp-2">${k.nama}</h3>
                        </div>
                        <div class="border-t border-white/10 p-3 flex justify-end space-x-2 bg-slate-800/50">
                            <button data-action="view-kegiatan" data-id="${k.id}" class="action-btn" title="Lihat"><i class="fas fa-eye text-xs"></i></button>
                            ${currentUserRole === 'admin' ? adminButtons : ''}
                        </div>
                    </div>`
                }
            }
        };

        const createFormModalFor = async (type, id = null, extraData = {}) => {
            const config = definitions[type];
            let docData = {};
            if (id) {
                try {
                    const docSnap = await getDoc(doc(db, config.collectionName, id));
                    if (docSnap.exists()) {
                        docData = docSnap.data();
                    }
                } catch (e) {
                    console.error("Gagal mengambil dokumen:", e);
                    showNotification("Gagal memuat data untuk diedit.", true);
                }
            }
            
            const modalId = `${config.collectionName}-modal-${id || 'new'}`;
            const zIndex = document.getElementById('manage-organisasi-modal') ? 150 : 100;
            let formContent = '';

            if (type === 'organisasi') {
                const infoKetua = docData.infoKetua || {};
                formContent = `
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-lg font-bold mb-3 border-b border-white/10 pb-2">Informasi Organisasi</h4>
                            <div class="space-y-4">
                                <div class="text-center">
                                    <input type="hidden" name="logo" value="${docData.logo || ''}">
                                    <img id="logo-preview" src="${docData.logo || 'https://placehold.co/128x128/334155/e5e7eb?text=Logo'}" class="w-24 h-24 rounded-lg object-cover mx-auto mb-2">
                                    <button type="button" class="upload-btn-logo bg-white/10 text-xs px-3 py-1 rounded-lg">Pilih Logo</button>
                                    <input type="file" id="logo-input" class="hidden" accept="image/*">
                                </div>
                                <div><label class="block text-sm mb-1">Nama Organisasi</label><input type="text" name="nama" class="input-field-custom" value="${docData.nama || ''}" required></div>
                                <div><label class="block text-sm mb-1">Alamat Organisasi</label><textarea name="alamat" class="input-field-custom" rows="3">${docData.alamat || ''}</textarea></div>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-bold mb-3 border-b border-white/10 pb-2">Informasi Ketua</h4>
                            <div class="space-y-4">
                                <div class="text-center">
                                    <input type="hidden" name="infoKetua.foto" value="${infoKetua.foto || ''}">
                                    <img id="ketua-photo-preview" src="${infoKetua.foto || 'https://placehold.co/128x128/334155/e5e7eb?text=Foto'}" class="w-24 h-24 rounded-full object-cover mx-auto mb-2">
                                    <button type="button" class="upload-btn-ketua bg-white/10 text-xs px-3 py-1 rounded-lg">Pilih Foto Ketua</button>
                                    <input type="file" id="ketua-photo-input" class="hidden" accept="image/*">
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div><label class="block text-sm mb-1">Nama Lengkap Ketua</label><input type="text" name="infoKetua.nama" class="input-field-custom" value="${infoKetua.nama || ''}" required></div>
                                    <div><label class="block text-sm mb-1">Kontak Ketua</label><input type="tel" name="infoKetua.kontak" class="input-field-custom" value="${infoKetua.kontak || ''}"></div>
                                    <div><label class="block text-sm mb-1">Tempat Lahir Ketua</label><input type="text" name="infoKetua.tempatLahir" class="input-field-custom" value="${infoKetua.tempatLahir || ''}"></div>
                                    <div><label class="block text-sm mb-1">Tanggal Lahir Ketua</label><input type="date" name="infoKetua.tanggalLahir" class="input-field-custom" value="${infoKetua.tanggalLahir || ''}"></div>
                                    <div class="sm:col-span-2"><label class="block text-sm mb-1">Alamat Ketua</label><textarea name="infoKetua.alamat" class="input-field-custom" rows="3">${infoKetua.alamat || ''}</textarea></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (type === 'pengurus') {
                formContent = `
                    <input type="hidden" name="foto" value="${docData.foto || ''}">
                    <div class="text-center">
                         <img id="photo-preview" src="${docData.foto || 'https://placehold.co/128x128/334155/e5e7eb?text=Foto'}" class="w-24 h-24 sm:w-32 sm:h-32 rounded-lg object-cover mx-auto mb-4" onerror="this.src='https://placehold.co/128x128/334155/e5e7eb?text=Foto'">
                         <input type="file" id="photo-input" class="hidden" accept="image/*">
                         <button type="button" class="upload-btn bg-white/10 text-sm px-4 py-2 rounded-lg">Pilih Gambar</button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm mb-1">Kategori</label>
                            <select name="kategori" id="kategori-select" class="input-field-custom">
                                <option value="inti" ${docData.kategori === 'inti' ? 'selected' : ''}>Pengurus Inti</option>
                                <option value="bidang" ${docData.kategori === 'bidang' ? 'selected' : ''}>Pengurus Bidang</option>
                            </select>
                        </div>
                        <div id="nama-bidang-container" class="${docData.kategori === 'bidang' ? '' : 'hidden'}">
                            <label class="block text-sm mb-1">Nama Bidang</label>
                            <input type="text" name="namaBidang" class="input-field-custom" value="${docData.namaBidang || ''}">
                        </div>
                        <div class="sm:col-span-2"><label class="block text-sm mb-1">Nama Lengkap</label><input type="text" name="nama" class="input-field-custom" value="${docData.nama || ''}" required></div>
                        <div class="sm:col-span-2"><label class="block text-sm mb-1">Jabatan</label><input type="text" name="jabatan" class="input-field-custom" value="${docData.jabatan || ''}" required></div>
                        <div><label class="block text-sm mb-1">Tempat Lahir</label><input type="text" name="tempatLahir" class="input-field-custom" value="${docData.tempatLahir || ''}"></div>
                        <div><label class="block text-sm mb-1">Tanggal Lahir</label><input type="date" name="tanggalLahir" class="input-field-custom" value="${docData.tanggalLahir || ''}"></div>
                        <div class="sm:col-span-2"><label class="block text-sm mb-1">Kontak</label><input type="tel" name="kontak" class="input-field-custom" value="${docData.kontak || ''}"></div>
                        <div class="sm:col-span-2"><label class="block text-sm mb-1">Alamat</label><textarea name="alamat" class="input-field-custom" rows="3">${docData.alamat || ''}</textarea></div>
                    </div>
                `;
            } else if (type === 'usulan') {
                let orgFieldHtml = '';
                if (currentUserRole === 'admin') {
                    const orgSnapshot = await getDocs(query(collection(db, 'organisasi'), orderBy("nama", "asc")));
                    let orgOptions = '<option value="">Pilih Organisasi</option>';
                    orgSnapshot.forEach(doc => {
                        const orgName = doc.data().nama;
                        const isSelected = docData.namaOrganisasi === orgName ? 'selected' : '';
                        orgOptions += `<option value="${orgName}" ${isSelected}>${orgName}</option>`;
                    });
                    orgFieldHtml = `<div class="sm:col-span-2"><label class="block text-sm mb-1">Nama Organisasi Pengusul</label><select name="namaOrganisasi" class="input-field-custom" required>${orgOptions}</select></div>`;
                } else if (currentUserRole === 'organisasi') {
                    orgFieldHtml = `
                        <div class="sm:col-span-2">
                            <label class="block text-sm mb-1">Nama Organisasi Pengusul</label>
                            <input type="hidden" name="namaOrganisasi" value="${currentUserOrganisasi}">
                            <p class="input-field-custom bg-slate-700/50">${currentUserOrganisasi}</p>
                        </div>
                    `;
                }

                formContent = `
                    <input type="hidden" name="status" value="${docData.status || 'Diajukan'}">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full">
                        <div class="sm:col-span-2"><label class="block text-sm mb-1">Nama Kegiatan</label><input type="text" name="namaKegiatan" class="input-field-custom" value="${docData.namaKegiatan || ''}" required></div>
                        ${orgFieldHtml}
                        <div><label class="block text-sm mb-1">Tanggal Pelaksanaan (Estimasi)</label><input type="date" name="tanggalPelaksanaan" class="input-field-custom" value="${docData.tanggalPelaksanaan || ''}"></div>
                        <div><label class="block text-sm mb-1">Lokasi Kegiatan</label><input type="text" name="lokasiKegiatan" class="input-field-custom" value="${docData.lokasiKegiatan || ''}"></div>
                        <div class="sm:col-span-2"><label class="block text-sm mb-1">Anggaran (Estimasi)</label><input type="number" name="anggaran" class="input-field-custom" value="${docData.anggaran || ''}"></div>
                        <div class="sm:col-span-2"><label class="block text-sm mb-1">Sasaran Kegiatan</label><input type="text" name="sasaranKegiatan" class="input-field-custom" value="${docData.sasaranKegiatan || ''}"></div>
                        <div class="sm:col-span-2"><label class="block text-sm mb-1">Deskripsi Singkat</label><textarea name="deskripsi" class="input-field-custom" rows="3" required>${docData.deskripsi || ''}</textarea></div>
                        <div class="sm:col-span-2"><label class="block text-sm mb-1">Target yang Akan Dicapai</label><textarea name="targetCapaian" class="input-field-custom" rows="3">${docData.targetCapaian || ''}</textarea></div>
                    </div>
                `;
            } else { // Generic form builder including for 'dokumentasi'
                const photoSrc = config.photoField ? docData[config.photoField] || '' : '';
                const fields = config.fields || [];
                
                const photoHtml = config.photoField ? `<input type="hidden" name="${config.photoField}" value="${photoSrc}"><div class="text-center sm:col-span-2">
                         <img id="photo-preview" src="${photoSrc || 'https://placehold.co/128x128/334155/e5e7eb?text=Foto'}" class="w-24 h-24 sm:w-32 sm:h-32 rounded-lg object-cover mx-auto mb-4" onerror="this.src='https://placehold.co/128x128/334155/e5e7eb?text=Foto'">
                         <input type="file" id="photo-input" class="hidden" accept="image/*">
                         <button type="button" class="upload-btn bg-white/10 text-sm px-4 py-2 rounded-lg">Pilih Gambar</button>
                    </div>` : '';

                const fileHtml = config.fileUpload ? `
                        <div class="sm:col-span-2">
                            <label class="block text-sm mb-1">Unggah File (Hanya .pdf, maks 500KB)</label>
                            <input type="file" id="file-input" class="hidden" accept=".pdf">
                            <button type="button" class="upload-btn bg-white/10 text-sm px-4 py-2 rounded-lg w-full"><i class="fas fa-upload mr-2"></i>Pilih File</button>
                            <p id="file-name-display" class="text-xs text-gray-400 mt-2">Belum ada file dipilih</p>
                        </div>
                    ` : '';
                
                const fieldsHtml = fields.map(f => {
                    const colSpan = (f.type === 'textarea' || ['nama', 'jabatan', 'judul', 'namaKegiatan', 'namaOrganisasi'].includes(f.name)) ? 'sm:col-span-2' : '';
                    if (f.type === 'hidden') return `<input type="hidden" name="${f.name}" value="${docData[f.name] || 'Diajukan'}">`;
                    if (f.type === 'textarea') {
                        return `<div class="${colSpan}"><label class="block text-sm mb-1">${f.label}</label><textarea name="${f.name}" class="input-field-custom" rows="3">${docData[f.name] || ''}</textarea></div>`;
                    }
                    return `<div class="${colSpan}"><label class="block text-sm mb-1">${f.label}</label><input type="${f.type}" name="${f.name}" class="input-field-custom" value="${docData[f.name] || ''}" ${f.required ? 'required' : ''}></div>`;
                }).join('');

                formContent = `
                    ${Object.entries(extraData).map(([key, value]) => `<input type="hidden" name="${key}" value="${value}">`).join('')}
                    ${photoHtml}
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full">
                        ${fieldsHtml}
                        ${fileHtml}
                    </div>
                `;
            }

            createModal(modalId, id ? `Edit ${config.title}` : `Tambah ${config.title}`, `
                <form id="data-form-${type}-${id || 'new'}" class="space-y-4">
                    ${formContent}
                    <div class="pt-4 flex justify-end"><button type="submit" class="btn-primary text-white px-4 py-2 rounded-lg">Simpan</button></div>
                </form>
            `, type === 'organisasi' ? 'max-w-2xl' : 'max-w-lg', zIndex);
            
            const form = document.getElementById(`data-form-${type}-${id || 'new'}`);

            if (type === 'pengurus') {
                const kategoriSelect = form.querySelector('#kategori-select');
                const namaBidangContainer = form.querySelector('#nama-bidang-container');
                kategoriSelect.onchange = (e) => {
                    namaBidangContainer.classList.toggle('hidden', e.target.value !== 'bidang');
                };
            }

            const setupPhotoUpload = (btnSelector, inputSelector, previewSelector, hiddenInputName) => {
                const uploadBtn = form.querySelector(btnSelector);
                const fileInput = form.querySelector(inputSelector);
                if (!uploadBtn || !fileInput) return;
                
                uploadBtn.onclick = () => fileInput.click();
                fileInput.onchange = async e => {
                    const file = e.target.files[0]; if (!file) return;
                    try {
                        const compressedDataUrl = await compressImage(file);
                        form.querySelector(previewSelector).src = compressedDataUrl;
                        form.querySelector(`input[name="${hiddenInputName}"]`).value = compressedDataUrl;
                    } catch (error) {
                        console.error("Gagal memproses gambar:", error);
                        showNotification("Gagal memproses gambar.", true);
                    }
                };
            };
            
            if (type === 'organisasi') {
                setupPhotoUpload('.upload-btn-logo', '#logo-input', '#logo-preview', 'logo');
                setupPhotoUpload('.upload-btn-ketua', '#ketua-photo-input', '#ketua-photo-preview', 'infoKetua.foto');
            } else if (config.photoField) {
                setupPhotoUpload('.upload-btn', '#photo-input', '#photo-preview', config.photoField);
            } else if (config.fileUpload) {
                if (docData.fileName) form.querySelector('#file-name-display').textContent = docData.fileName;
                const uploadBtn = form.querySelector('.upload-btn');
                const fileInput = form.querySelector('#file-input');
                uploadBtn.onclick = () => fileInput.click();
                fileInput.onchange = e => {
                    const file = e.target.files[0]; if (!file) return;

                    if (file.size > 500 * 1024) { // 500KB limit
                        showNotification('Ukuran file terlalu besar. Maksimal 500KB.', true);
                        fileInput.value = ''; // Reset file input
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        form.querySelector(`input[name="file"]`).value = event.target.result;
                        form.querySelector(`input[name="fileName"]`).value = file.name;
                        form.querySelector('#file-name-display').textContent = file.name;
                    };
                    reader.readAsDataURL(file);
                };
            }

            form.onsubmit = async (e) => {
                e.preventDefault();
                await saveData(config.collectionName, id, new FormData(e.target));
                document.getElementById(modalId)?.remove();
            };
        };
        
        const updateUsulanStatus = async (id, newStatus, reason = null) => {
            try {
                const dataToUpdate = { status: newStatus };
                if (reason !== null) {
                    dataToUpdate.alasanDitolak = reason;
                }
                await updateDoc(doc(db, 'usulanKegiatan', id), dataToUpdate);
                showNotification(`Status usulan berhasil diubah menjadi "${newStatus}"`);
                const modal = document.getElementById(`view-usulan-modal-${id}`);
                if (modal) {
                    modal.querySelector('.close-modal-btn').click();
                }
            } catch (error) {
                console.error("Gagal mengubah status usulan:", error);
                showNotification("Gagal mengubah status.", true);
            }
        };
        
        const showRejectReasonModal = (id) => {
            const content = `
                <form id="reject-reason-form">
                    <p class="text-gray-300 mb-4">Harap berikan alasan mengapa usulan ini ditolak.</p>
                    <div>
                        <label for="rejection-reason" class="block text-sm font-medium text-slate-300 mb-1">Alasan Penolakan</label>
                        <textarea id="rejection-reason" name="alasanDitolak" class="input-field-custom" rows="4" required></textarea>
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button type="submit" class="btn-primary text-white px-4 py-2 rounded-lg">Simpan Alasan</button>
                    </div>
                </form>
            `;
            createModal('reject-reason-modal', 'Alasan Penolakan', content, 'max-w-md');

            document.getElementById('reject-reason-form').onsubmit = async (e) => {
                e.preventDefault();
                const reason = e.target.elements.alasanDitolak.value;
                await updateUsulanStatus(id, 'Ditolak', reason);
                document.getElementById('reject-reason-modal')?.remove();
            };
        };

        const viewDetail = async (type, id) => {
            if (currentUserRole === 'publik' && (type === 'pengurus' || type === 'organisasi' || type === 'usulan' || type === 'dokumentasi' || type === 'anggota')) {
                showNotification('Anda harus login untuk melihat detail.', true);
                return;
            }

            const config = definitions[type];
            try {
                const docSnap = await getDoc(doc(db, config.collectionName, id));
                if (!docSnap.exists()) { 
                    showNotification("Data tidak ditemukan.", true); 
                    return; 
                }
                const data = docSnap.data();
                
                let content = '';
                const zIndex = document.getElementById('manage-organisasi-modal') ? 150 : 100;

                if (type === 'pengurus' || type === 'anggota') {
                    const avatar = data.foto ? `<img src="${data.foto}" class="w-20 h-20 rounded-full object-cover" onerror="this.src='https://placehold.co/80x80/ec4899/ffffff?text=${data.nama.charAt(0)}'">` : `<div class="w-20 h-20 rounded-full bg-gradient-to-br from-pink-500 to-fuchsia-600 flex items-center justify-center"><span class="text-3xl font-bold">${data.nama.charAt(0)}</span></div>`;
                    content = `
                        <div class="space-y-4">
                            <div class="flex flex-col sm:flex-row items-center text-center sm:text-left gap-4">${avatar}<div><h3 class="text-xl sm:text-2xl font-bold">${data.nama}</h3><p class="text-md sm:text-lg text-pink-400">${data.jabatan}</p></div></div>
                            ${data.kategori === 'bidang' ? `<p class="text-md text-slate-400"><strong>Bidang:</strong> ${data.namaBidang || '-'}</p>` : ''}
                            <div class="border-t border-white/10 pt-4 mt-4 space-y-2 text-sm">
                                <div><strong class="w-24 inline-block text-gray-400">Lahir</strong>: ${data.tempatLahir || '-'}, ${data.tanggalLahir ? new Date(data.tanggalLahir).toLocaleDateString('id-ID') : '-'}</div>
                                <div><strong class="w-24 inline-block text-gray-400">Kontak</strong>: ${data.kontak || '-'}</div>
                                <div class="flex"><strong class="w-24 inline-block text-gray-400 flex-shrink-0">Alamat</strong>: <p class="flex-1 ml-2">${data.alamat || '-'}</p></div>
                            </div>
                        </div>`;
                } else if (type === 'usulan') {
                    const statusColors = {
                            'Diajukan': 'bg-yellow-500/20 text-yellow-400',
                            'Diverifikasi': 'bg-blue-500/20 text-blue-400',
                            'Disetujui': 'bg-green-500/20 text-green-400',
                            'Ditolak': 'bg-red-500/20 text-red-400',
                        };
                    const statusColor = statusColors[data.status] || 'bg-gray-500/20 text-gray-400';
                    const reasonHtml = data.status === 'Ditolak' && data.alasanDitolak ? `
                        <div class="border-t border-white/10 pt-4 mt-4">
                            <h4 class="font-bold mb-2 text-red-400">Alasan Ditolak</h4>
                            <p class="text-gray-300 whitespace-pre-wrap text-justify">${data.alasanDitolak}</p>
                        </div>
                    ` : '';
                    const adminActions = `
                        <div class="border-t border-white/10 pt-4 mt-4 flex justify-end gap-3">
                            <button data-action="reject-usulan" data-id="${id}" class="bg-red-600/80 text-white px-4 py-2 rounded-lg text-sm font-medium">Tolak</button>
                            <button data-action="verify-usulan" data-id="${id}" class="bg-blue-600/80 text-white px-4 py-2 rounded-lg text-sm font-medium">Verifikasi</button>
                            <button data-action="approve-usulan" data-id="${id}" class="bg-green-600/80 text-white px-4 py-2 rounded-lg text-sm font-medium">Setujui</button>
                        </div>
                    `;
                    content = `
                        <div class="space-y-4">
                            <div>
                                <span class="text-xs font-medium ${statusColor} px-2 py-1 rounded-full">${data.status}</span>
                                <h3 class="text-xl sm:text-2xl font-bold mt-2">${data.namaKegiatan}</h3>
                                <p class="text-sm text-slate-400 mt-1"><i class="fas fa-sitemap mr-2"></i> Diusulkan oleh: <strong>${data.namaOrganisasi}</strong></p>
                            </div>
                            <div class="border-t border-white/10 pt-4 mt-4 space-y-2 text-sm">
                                <div><strong class="w-32 inline-block text-gray-400">Tanggal Estimasi</strong>: ${data.tanggalPelaksanaan || '-'}</div>
                                <div><strong class="w-32 inline-block text-gray-400">Lokasi</strong>: ${data.lokasiKegiatan || '-'}</div>
                                <div><strong class="w-32 inline-block text-gray-400">Anggaran Estimasi</strong>: Rp ${new Intl.NumberFormat('id-ID').format(data.anggaran || 0)}</div>
                                <div><strong class="w-32 inline-block text-gray-400">Sasaran</strong>: ${data.sasaranKegiatan || '-'}</div>
                            </div>
                            <div class="border-t border-white/10 pt-4 mt-4">
                                <h4 class="font-bold mb-2">Deskripsi</h4>
                                <p class="text-gray-300 whitespace-pre-wrap text-justify">${data.deskripsi || 'Tidak ada deskripsi.'}</p>
                            </div>
                            <div class="border-t border-white/10 pt-4 mt-4">
                                <h4 class="font-bold mb-2">Target yang Akan Dicapai</h4>
                                <p class="text-gray-300 whitespace-pre-wrap text-justify">${data.targetCapaian || 'Tidak ada target.'}</p>
                            </div>
                            ${reasonHtml}
                            ${currentUserRole === 'admin' ? adminActions : ''}
                        </div>
                    `;
                } else if (type === 'kegiatan') {
                    content = `
                        <div class="space-y-4">
                            <img src="${data.foto || 'https://placehold.co/600x400/334155/e5e7eb?text=Kegiatan'}" class="w-full h-48 object-cover rounded-lg" onerror="this.src='https://placehold.co/600x400/334155/e5e7eb?text=Kegiatan'">
                            <h3 class="text-xl sm:text-2xl font-bold">${data.nama}</h3>
                            <p class="text-pink-400 text-sm sm:text-base"><i class="fas fa-calendar-alt mr-2"></i>${data.tanggal} &nbsp;&nbsp;&nbsp; <i class="fas fa-map-marker-alt mr-2"></i>${data.lokasi}</p>
                            <p class="text-gray-300 text-justify">${data.deskripsi || 'Tidak ada deskripsi.'}</p>
                        </div>
                    `;
                } else if (type === 'dokumentasi') {
                    content = `
                        <div class="space-y-4">
                            <div>
                                <span class="text-xs font-medium bg-slate-700 text-slate-300 px-2 py-1 rounded-full">${data.kategori}</span>
                                <h3 class="text-xl sm:text-2xl font-bold mt-2">${data.judul}</h3>
                                <p class="text-sm text-slate-400 mt-1"><i class="fas fa-calendar-alt mr-2"></i>${data.tanggal}</p>
                            </div>
                            <div class="border-t border-white/10 pt-4 mt-4">
                                <h4 class="font-bold mb-2">Deskripsi</h4>
                                <p class="text-gray-300 whitespace-pre-wrap text-justify">${data.deskripsi || 'Tidak ada deskripsi.'}</p>
                            </div>
                            ${data.file && data.fileName ? `
                            <div class="border-t border-white/10 pt-4 mt-4">
                                <h4 class="font-bold mb-2">File</h4>
                                <div class="flex items-center justify-between bg-slate-800/50 p-3 rounded-lg">
                                    <div>
                                        <p class="font-semibold text-sm"><i class="fas fa-file-alt mr-2"></i>${data.fileName}</p>
                                    </div>
                                    <button data-action="download-dokumentasi" data-id="${id}" class="btn-primary text-white px-4 py-2 rounded-lg text-sm">Download</button>
                                </div>
                            </div>` : ''}
                        </div>
                    `;
                } else if (type === 'organisasi') {
                    const infoKetua = data.infoKetua || {};
                    const logo = data.logo ? `<img src="${data.logo}" class="w-24 h-24 rounded-lg object-cover" onerror="this.src='https://placehold.co/96x96/334155/e5e7eb?text=Logo'">` : `<div class="w-24 h-24 rounded-lg bg-slate-700 flex items-center justify-center"><i class="fas fa-sitemap text-4xl"></i></div>`;
                    const ketuaAvatar = infoKetua.foto ? `<img src="${infoKetua.foto}" class="w-20 h-20 rounded-full object-cover" onerror="this.src='https://placehold.co/80x80/ec4899/ffffff?text=${(infoKetua.nama || '?').charAt(0)}'">` : `<div class="w-20 h-20 rounded-full bg-gradient-to-br from-pink-500 to-fuchsia-600 flex items-center justify-center"><span class="text-3xl font-bold">${(infoKetua.nama || '?').charAt(0)}</span></div>`;
                    content = `
                        <div class="space-y-6">
                            <div class="flex flex-col sm:flex-row items-center gap-6">
                                ${logo}
                                <div class="flex-1 text-center sm:text-left">
                                    <h3 class="text-2xl sm:text-3xl font-bold">${data.nama}</h3>
                                    <p class="text-sm sm:text-md text-slate-400 mt-1"><i class="fas fa-map-marker-alt fa-fw mr-2"></i>${data.alamat || 'Alamat tidak tersedia'}</p>
                                </div>
                            </div>
                            <div class="border-t border-white/10 pt-4">
                                <h4 class="text-lg font-bold mb-4">Informasi Ketua</h4>
                                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                                    ${ketuaAvatar}
                                    <div>
                                        <h3 class="text-xl sm:text-2xl font-bold">${infoKetua.nama || '-'}</h3>
                                        <p class="text-md sm:text-lg text-pink-400">Ketua Organisasi</p>
                                    </div>
                                </div>
                                <div class="border-t border-white/10 pt-4 mt-4 space-y-2 text-sm">
                                    <div><strong class="w-24 inline-block text-gray-400">Lahir</strong>: ${infoKetua.tempatLahir || '-'}, ${infoKetua.tanggalLahir ? new Date(infoKetua.tanggalLahir).toLocaleDateString('id-ID') : '-'}</div>
                                    <div><strong class="w-24 inline-block text-gray-400">Kontak</strong>: ${infoKetua.kontak || '-'}</div>
                                    <div class="flex"><strong class="w-24 inline-block text-gray-400 flex-shrink-0">Alamat</strong>: <p class="flex-1 ml-2">${infoKetua.alamat || '-'}</p></div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                createModal(`view-${type}-modal-${id}`, `Detail ${config.title}`, content, 'max-w-2xl', zIndex);
            } catch (error) {
                console.error("Gagal membuka detail: ", error);
                if (error.code === 'permission-denied') {
                    showNotification('Anda tidak memiliki izin untuk melihat detail ini.', true);
                } else {
                    showNotification('Gagal memuat data detail.', true);
                }
            }
        };

        const manageOrganisasi = async (id) => {
            const orgDoc = await getDoc(doc(db, 'organisasi', id));
            if (!orgDoc.exists()) { showNotification("Organisasi tidak ditemukan", true); return; }
            const orgData = orgDoc.data();
            const ketua = orgData.infoKetua || {};
            
            const canManage = currentUserRole === 'admin' || (currentUserRole === 'organisasi' && orgData.nama === currentUserOrganisasi);
            
            const ketuaAvatar = ketua.foto 
                ? `<img src="${ketua.foto}" class="w-10 h-10 rounded-full object-cover" onerror="this.src='https://placehold.co/40x40/ec4899/ffffff?text=${(ketua.nama || '?').charAt(0)}'"/>` 
                : `<div class="w-10 h-10 rounded-full bg-pink-500 flex items-center justify-center text-sm flex-shrink-0">${(ketua.nama || '?').charAt(0)}</div>`;

            const content = `
                <div class="space-y-6">
                    <div class="flex items-center gap-4">
                        ${ketuaAvatar}
                        <div>
                            <h3 class="text-xl sm:text-2xl font-bold">${orgData.nama}</h3>
                            <p class="text-sm sm:text-md text-slate-400">Ketua: ${ketua.nama || '-'}</p>
                        </div>
                    </div>
                    <div class="border-t border-white/10 pt-4">
                        <h4 class="font-bold mb-2 text-lg">Daftar Anggota</h4>
                        <ul id="anggota-list" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                            <li class="text-center text-slate-400 py-4">Memuat anggota...</li>
                        </ul>
                    </div>
                    ${canManage ? `
                    <div class="border-t border-white/10 pt-4">
                        <h4 class="font-bold mb-3 text-lg">Tambah Anggota Baru</h4>
                        <form id="add-anggota-form" class="space-y-4">
                            <input type="hidden" name="organisasi" value="${orgData.nama}">
                            <input type="hidden" name="foto" value="">
                            <div class="text-center">
                                <img id="anggota-photo-preview" src="https://placehold.co/128x128/334155/e5e7eb?text=Foto" class="w-24 h-24 rounded-full object-cover mx-auto mb-2" onerror="this.src='https://placehold.co/128x128/334155/e5e7eb?text=Foto'">
                                <input type="file" id="anggota-photo-input" class="hidden" accept="image/*">
                                <button type="button" id="anggota-upload-btn" class="bg-white/10 text-xs px-3 py-1 rounded-lg">Pilih Foto</button>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><label class="block text-sm mb-1">Nama Lengkap</label><input type="text" name="nama" class="input-field-custom" required></div>
                                <div><label class="block text-sm mb-1">Jabatan</label><input type="text" name="jabatan" class="input-field-custom" required></div>
                                <div><label class="block text-sm mb-1">Tempat Lahir</label><input type="text" name="tempatLahir" class="input-field-custom"></div>
                                <div><label class="block text-sm mb-1">Tanggal Lahir</label><input type="date" name="tanggalLahir" class="input-field-custom"></div>
                                <div class="sm:col-span-2"><label class="block text-sm mb-1">Kontak</label><input type="tel" name="kontak" class="input-field-custom"></div>
                                <div class="sm:col-span-2"><label class="block text-sm mb-1">Alamat</label><textarea name="alamat" class="input-field-custom" rows="3"></textarea></div>
                            </div>
                            <div class="flex justify-end"><button type="submit" class="btn-primary text-white px-4 py-2 rounded-lg">Tambah Anggota</button></div>
                        </form>
                    </div>` : ''}
                </div>
            `;
            
            const modalTitle = canManage ? 'Kelola Anggota Organisasi' : 'Daftar Anggota';
            createModal('manage-organisasi-modal', modalTitle, content, 'max-w-3xl', 100);
            
            const anggotaList = document.getElementById('anggota-list');
            const q = query(collection(db, 'anggota'), where("organisasi", "==", orgData.nama));
            
            modalUnsubscribe = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    anggotaList.innerHTML = '<li class="text-center text-slate-400 py-4">Belum ada anggota.</li>';
                    return;
                }
                const docs = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().createdAt?.toMillis() || 0;
                    const timeB = b.data().createdAt?.toMillis() || 0;
                    return timeA - timeB;
                });

                anggotaList.innerHTML = docs.map(doc => {
                    const anggota = { id: doc.id, ...doc.data() };
                    const avatar = anggota.foto ? `<img src="${anggota.foto}" class="w-10 h-10 rounded-full object-cover" onerror="this.src='https://placehold.co/40x40/ec4899/ffffff?text=${anggota.nama.charAt(0)}'">` : `<div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm">${anggota.nama.charAt(0)}</div>`;
                    const crudButtons = `
                        <button data-action="edit-anggota" data-id="${anggota.id}" class="action-btn" title="Edit Anggota"><i class="fas fa-edit text-xs"></i></button>
                        <button data-action="delete" data-collection="anggota" data-id="${anggota.id}" data-name="${anggota.nama}" class="action-btn" title="Hapus Anggota"><i class="fas fa-trash text-xs"></i></button>
                    `;
                    return `
                        <li class="flex items-center justify-between bg-slate-800/50 p-2 rounded-lg">
                            <div class="flex items-center gap-3">
                                ${avatar}
                                <div>
                                    <p class="font-semibold text-sm">${anggota.nama}</p>
                                    <p class="text-xs text-slate-400">${anggota.jabatan}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-action="view-anggota" data-id="${anggota.id}" class="action-btn" title="Lihat Detail"><i class="fas fa-eye text-xs"></i></button>
                                ${canManage ? crudButtons : ''}
                            </div>
                        </li>
                    `;
                }).join('');
            });

            if (canManage) {
                const addAnggotaForm = document.getElementById('add-anggota-form');
                const uploadBtn = document.getElementById('anggota-upload-btn');
                const photoInput = document.getElementById('anggota-photo-input');
                const photoPreview = document.getElementById('anggota-photo-preview');
                const hiddenPhotoInput = addAnggotaForm.querySelector('input[name="foto"]');

                uploadBtn.onclick = () => photoInput.click();
                photoInput.onchange = async e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try {
                        const compressedDataUrl = await compressImage(file);
                        photoPreview.src = compressedDataUrl;
                        hiddenPhotoInput.value = compressedDataUrl;
                    } catch (error) {
                        console.error("Gagal memproses gambar:", error);
                        showNotification("Gagal memproses gambar.", true);
                    }
                };

                addAnggotaForm.onsubmit = async (e) => {
                    e.preventDefault();
                    await saveData('anggota', null, new FormData(e.target));
                    addAnggotaForm.reset();
                    photoPreview.src = 'https://placehold.co/128x128/334155/e5e7eb?text=Foto';
                    addAnggotaForm.elements['organisasi'].value = orgData.nama;
                };
            }
        };
        
        const renderPengurusPage = () => {
            const config = definitions.pengurus;
            mainContent.innerHTML = `
                <div class="space-y-4">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div class="relative w-full sm:w-auto sm:flex-1">
                            <input type="text" id="search-input" placeholder="Cari pengurus..." class="input-field-custom pl-10">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            ${currentUserRole !== 'publik' ? `<button data-action="export-pengurus" class="bg-white/10 text-white px-4 py-2 rounded-lg text-sm font-medium"><i class="fas fa-print mr-2"></i>Export PDF</button>` : ''}
                            ${currentUserRole === 'admin' ? `
                                <button data-action="add-pengurus" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium"><i class="fas fa-plus mr-2"></i>Tambah</button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div id="pengurus-content" class="space-y-8">
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold mb-4 border-b-2 border-pink-500 pb-2">Pengurus Inti</h2>
                            <div id="pengurus-inti-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6"></div>
                        </div>
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold mb-4 border-b-2 border-pink-500 pb-2">Bidang-Bidang</h2>
                            <div id="bidang-container" class="space-y-6"></div>
                        </div>
                    </div>
                </div>`;

            const searchInput = mainContent.querySelector('#search-input');
            let allData = [];

            const renderData = (filter = '') => {
                const lowerFilter = filter.toLowerCase();
                const filteredData = allData.filter(item => 
                    config.searchFields.some(field => 
                        item[field] && String(item[field]).toLowerCase().includes(lowerFilter)
                    )
                );

                const pengurusInti = filteredData.filter(p => p.kategori === 'inti' || !p.kategori);
                const pengurusBidang = filteredData.filter(p => p.kategori === 'bidang');

                const pengurusIntiGrid = mainContent.querySelector('#pengurus-inti-grid');
                const bidangContainer = mainContent.querySelector('#bidang-container');

                pengurusIntiGrid.innerHTML = pengurusInti.length > 0 
                    ? pengurusInti.map(renderPengurusCard).join('')
                    : `<div class="col-span-full text-center py-10 card-base rounded-xl bg-slate-800 flex flex-col items-center justify-center"><i class="fas fa-user-slash text-3xl text-gray-500 mb-3"></i><p>Data Pengurus Inti Kosong</p></div>`;

                const bidangGrouped = pengurusBidang.reduce((acc, p) => {
                    const bidangName = p.namaBidang || 'Lainnya';
                    if (!acc[bidangName]) {
                        acc[bidangName] = [];
                    }
                    acc[bidangName].push(p);
                    return acc;
                }, {});

                bidangContainer.innerHTML = Object.keys(bidangGrouped).length > 0 
                    ? Object.entries(bidangGrouped).map(([namaBidang, anggota]) => `
                        <div class="card-base bg-slate-800 rounded-xl p-4">
                            <h3 class="text-lg sm:text-xl font-bold mb-4">${namaBidang}</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${anggota.map(renderPengurusCard).join('')}
                            </div>
                        </div>
                    `).join('')
                    : `<div class="text-center py-10 card-base rounded-xl bg-slate-800 flex flex-col items-center justify-center"><i class="fas fa-user-slash text-3xl text-gray-500 mb-3"></i><p>Data Pengurus Bidang Kosong</p></div>`;
            };

            const renderPengurusCard = (p) => {
                const avatar = p.foto ? `<img src="${p.foto}" class="w-16 h-16 rounded-full object-cover" onerror="this.src='https://placehold.co/64x64/334155/e5e7eb?text=${p.nama.charAt(0)}'">` : `<div class="w-16 h-16 rounded-full bg-black/20 flex items-center justify-center"><span class="text-2xl font-bold">${p.nama.charAt(0)}</span></div>`;
                const adminButtons = `
                    <button data-action="edit-pengurus" data-id="${p.id}" class="action-btn" title="Edit"><i class="fas fa-edit text-xs"></i></button>
                    <button data-action="delete" data-collection="pengurus" data-id="${p.id}" data-name="${p.nama}" class="action-btn" title="Hapus"><i class="fas fa-trash text-xs"></i></button>
                `;
                return `
                <div class="card-base rounded-xl p-4 bg-slate-900/50">
                    <div class="flex items-center space-x-4">${avatar}<div class="flex-1"><h3 class="text-base sm:text-lg font-bold">${p.nama}</h3><p class="text-sm text-pink-400">${p.jabatan}</p></div></div>
                    <div class="border-t border-white/20 my-4"></div>
                    <div class="flex justify-end space-x-2">
                        ${currentUserRole !== 'publik' ? `<button data-action="view-pengurus" data-id="${p.id}" class="action-btn" title="Lihat"><i class="fas fa-eye text-xs"></i></button>` : ''}
                        ${currentUserRole === 'admin' ? adminButtons : ''}
                    </div>
                </div>`;
            };

            searchInput.oninput = (e) => renderData(e.target.value);
            
            const q = query(collection(db, config.collectionName), orderBy("createdAt", "asc"));
            const unsub = onSnapshot(q, (snapshot) => {
                allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderData(searchInput.value);
            }, (error) => {
                console.error(`Gagal memuat data untuk koleksi '${config.collectionName}': `, error);
                mainContent.querySelector('#pengurus-content').innerHTML = `<div class="col-span-full text-center py-16 card-base rounded-xl bg-slate-800 flex flex-col items-center justify-center"><i class="fas fa-lock text-3xl text-yellow-400 mb-3"></i><p>Gagal memuat data pengurus.</p><p class="text-sm text-slate-400 mt-2">Pastikan aturan keamanan Firebase mengizinkan akses baca.</p></div>`;
            });
            activeListeners.push(unsub);
        };
        
        const renderCardPageFor = (type, params) => {
            if (type === 'pengurus') {
                renderPengurusPage();
                return;
            }

            const config = definitions[type];
            mainContent.innerHTML = `
                <div class="space-y-4">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div class="relative w-full sm:w-auto sm:flex-1">
                            <input type="text" id="search-input" placeholder="Cari ${config.title.toLowerCase()}..." class="input-field-custom pl-10">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            ${currentUserRole !== 'publik' && type === 'organisasi' ? `<button data-action="export-organisasi" class="bg-white/10 text-white px-4 py-2 rounded-lg text-sm font-medium"><i class="fas fa-print mr-2"></i>Export PDF</button>` : ''}
                            ${currentUserRole !== 'publik' && type === 'kegiatan' ? `<button data-action="export-kegiatan" class="bg-white/10 text-white px-4 py-2 rounded-lg text-sm font-medium"><i class="fas fa-print mr-2"></i>Export PDF</button>` : ''}
                            ${currentUserRole !== 'publik' && type === 'usulan' ? `
                                <button data-action="export-usulan-pdf" class="bg-white/10 text-white px-4 py-2 rounded-lg text-sm font-medium"><i class="fas fa-file-pdf mr-2"></i>Export PDF</button>
                                <button data-action="export-usulan-excel" class="bg-white/10 text-white px-4 py-2 rounded-lg text-sm font-medium"><i class="fas fa-file-excel mr-2"></i>Export Excel</button>
                            ` : ''}
                            ${(currentUserRole === 'admin' || (currentUserRole === 'organisasi' && type === 'usulan')) ? `
                                <button data-action="add-${type}" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium"><i class="fas fa-plus mr-2"></i>Tambah</button>
                            ` : ''}
                        </div>
                    </div>
                    <div id="data-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6"></div>
                </div>`;
            
            const grid = mainContent.querySelector('#data-grid');
            const searchInput = mainContent.querySelector('#search-input');
            let allData = [];
            let allAnggota = [];

            const renderGrid = (filter = '') => {
                const lowerFilter = filter.toLowerCase();
                let filteredData = allData.filter(item => 
                    config.searchFields.some(field => {
                        if (field.includes('.')) {
                            const [parent, child] = field.split('.');
                            return item[parent] && item[parent][child] && String(item[parent][child]).toLowerCase().includes(lowerFilter);
                        }
                        return item[field] && String(item[field]).toLowerCase().includes(lowerFilter);
                    })
                );

                if (currentUserRole === 'organisasi' && type === 'usulan') {
                    // Do not filter by current user's organization, show all.
                }

                grid.innerHTML = filteredData.length > 0 
                    ? filteredData.map(item => {
                        if (type === 'organisasi') {
                            const anggotaCount = allAnggota.filter(a => a.organisasi === item.nama).length;
                            return config.renderCardFn(item, anggotaCount);
                        }
                        return config.renderCardFn(item);
                    }).join('')
                    : `<div class="col-span-full text-center py-16 card-base rounded-xl bg-slate-800 flex flex-col items-center justify-center">${config.emptyMessage}</div>`;
            };

            searchInput.oninput = (e) => renderGrid(e.target.value);
            
            const sortOrder = (type === 'organisasi') ? 'asc' : 'desc';
            const q = query(collection(db, config.collectionName), orderBy("createdAt", sortOrder));
            const unsub1 = onSnapshot(q, (snapshot) => {
                allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const statusFilter = params ? params.get('status') : null;
                if (type === 'usulan' && statusFilter) {
                    searchInput.value = statusFilter;
                    renderGrid(statusFilter);
                } else {
                    renderGrid(searchInput.value);
                }
            }, (error) => {
                console.error(`Gagal memuat data untuk koleksi '${type}': `, error);
                if (grid && error.code === 'permission-denied') {
                     grid.innerHTML = `<div class="col-span-full text-center py-16 card-base rounded-xl bg-slate-800 flex flex-col items-center justify-center"><i class="fas fa-lock text-3xl text-yellow-400 mb-3"></i><p>Anda tidak memiliki izin untuk melihat data ini.</p><p class="text-sm text-slate-400 mt-2">Pastikan Anda sudah login dan aturan keamanan Firebase sudah benar.</p></div>`;
                } else if (grid) {
                     grid.innerHTML = `<div class="col-span-full text-center py-16 card-base rounded-xl bg-slate-800 flex flex-col items-center justify-center"><i class="fas fa-exclamation-triangle text-3xl text-red-400 mb-3"></i><p>Gagal memuat data.</p></div>`;
                }
            });
            activeListeners.push(unsub1);

            if (type === 'organisasi') {
                const unsub2 = onSnapshot(collection(db, 'anggota'), (snapshot) => {
                    allAnggota = snapshot.docs.map(doc => doc.data());
                    renderGrid(searchInput.value);
                }, (error) => {
                    console.error("Gagal memuat data anggota: ", error);
                    showNotification("Gagal memuat data hitungan anggota.", true);
                });
                activeListeners.push(unsub2);
            }
        };

        const renderDashboard = () => {
             mainContent.innerHTML = `
                <div class="space-y-6">
                    <div class="p-4 rounded-lg flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-white">Dashboard</h2>
                            <p class="text-slate-400 mt-1">Selamat datang di SiMANJA GOW!</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                        <a href="#pengurus" class="metric-card p-4 bg-gradient-to-br from-orange-500 to-amber-500">
                            <i class="fas fa-user-tie icon"></i>
                            <p class="text-xs sm:text-sm font-medium">Total Pengurus</p>
                            <p id="total-pengurus" class="text-2xl sm:text-3xl font-bold">0</p>
                        </a>
                        <a href="#organisasi" class="metric-card p-4 bg-gradient-to-br from-blue-500 to-sky-500">
                            <i class="fas fa-sitemap icon"></i>
                            <p class="text-xs sm:text-sm font-medium">Total Organisasi</p>
                            <p id="total-organisasi" class="text-2xl sm:text-3xl font-bold">0</p>
                        </a>
                        <a href="#usulan" class="metric-card p-4 bg-gradient-to-br from-purple-500 to-violet-500">
                            <i class="fas fa-lightbulb icon"></i>
                            <p class="text-xs sm:text-sm font-medium">Total Usulan</p>
                            <p id="total-usulan" class="text-2xl sm:text-3xl font-bold">0</p>
                        </a>
                        <a href="#kegiatan" class="metric-card p-4 bg-gradient-to-br from-pink-500 to-rose-500">
                            <i class="fas fa-calendar-check icon"></i>
                            <p class="text-xs sm:text-sm font-medium">Total Kegiatan</p>
                            <p id="total-kegiatan" class="text-2xl sm:text-3xl font-bold">0</p>
                        </a>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-3 card-base p-4 sm:p-5 rounded-xl">
                            <h3 class="font-bold text-base sm:text-lg mb-4">Jumlah Anggota per Organisasi</h3>
                            <div class="h-96"><canvas id="participationChart"></canvas></div>
                        </div>
                        <div class="lg:col-span-2 card-base p-4 sm:p-5 rounded-xl">
                            <h3 class="font-bold text-base sm:text-lg mb-4">Status Usulan Kegiatan</h3>
                            <div class="h-80"><canvas id="proposalStatusChart"></canvas></div>
                        </div>
                        <div> <!-- Wrapper for social media and copyright -->
                            <div class="card-base p-4 sm:p-5 rounded-xl flex flex-col justify-center">
                                 <h3 class="font-bold text-base sm:text-lg mb-4 text-center">Ikuti Kami</h3>
                                 <div class="flex justify-center items-center gap-4">
                                    <a href="https://www.instagram.com/gow_anambaskab" target="_blank" class="flex items-center justify-center w-12 h-12 bg-slate-800 rounded-full hover:bg-pink-600 transition-colors">
                                        <i class="fab fa-instagram text-2xl"></i>
                                    </a>
                                    <a href="https://www.facebook.com/share/14JrYrAff1V/" target="_blank" class="flex items-center justify-center w-12 h-12 bg-slate-800 rounded-full hover:bg-blue-600 transition-colors">
                                        <i class="fab fa-facebook text-2xl"></i>
                                    </a>
                                 </div>
                            </div>
                            <div class="text-center text-xs text-slate-500 pt-4">
                                <p>Hak Cipta &copy; GOW Kabupaten Kepulauan Anambas 2025</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // --- Logic untuk update dashboard ---
            const unsubPengurus = onSnapshot(collection(db, 'pengurus'), (snap) => {
                const el = document.getElementById('total-pengurus');
                if(el) el.textContent = snap.size;
            }, (error) => {
                console.error("Error getting total pengurus:", error);
                const el = document.getElementById('total-pengurus');
                if(el) {
                    el.textContent = 'X';
                    el.parentElement.title = 'Gagal memuat data. Periksa aturan keamanan Firebase.';
                }
            });
            const unsubOrganisasi = onSnapshot(collection(db, 'organisasi'), (snap) => {
                const el = document.getElementById('total-organisasi');
                if(el) el.textContent = snap.size;
            }, (error) => {
                console.error("Error getting total organisasi:", error);
                const el = document.getElementById('total-organisasi');
                if(el) {
                    el.textContent = 'X';
                    el.parentElement.title = 'Gagal memuat data. Periksa aturan keamanan Firebase.';
                }
            });
            const unsubUsulan = onSnapshot(collection(db, 'usulanKegiatan'), (snap) => {
                const el = document.getElementById('total-usulan');
                if(el) el.textContent = snap.size;
            }, (error) => {
                console.error("Error getting total usulan:", error);
                const el = document.getElementById('total-usulan');
                if(el) {
                    el.textContent = 'X';
                    el.parentElement.title = 'Gagal memuat data. Periksa aturan keamanan Firebase.';
                }
            });
            const unsubKegiatan = onSnapshot(collection(db, 'kegiatan'), (snap) => {
                const el = document.getElementById('total-kegiatan');
                if(el) el.textContent = snap.size;
            }, (error) => {
                console.error("Error getting total kegiatan:", error);
                const el = document.getElementById('total-kegiatan');
                if(el) {
                    el.textContent = 'X';
                    el.parentElement.title = 'Gagal memuat data. Periksa aturan keamanan Firebase.';
                }
            });

            const horizontalBarChartOptions = {
                indexAxis: 'y',
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false }, 
                    tooltip: { 
                        backgroundColor: '#1e293b', 
                        titleColor: '#f472b6',
                        bodyColor: '#e2e8f0',
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1,
                        borderRadius: 6,
                        padding: 10,
                        callbacks: {
                            label: function(context) {
                                return ` ${context.raw} Anggota`;
                            }
                        }
                    } 
                },
                scales: {
                    x: { 
                        beginAtZero: true,
                        ticks: { color: '#94a3b8', font: { size: 10 }, precision: 0 }, 
                        grid: { color: 'rgba(255,255,255,0.05)' } 
                    },
                    y: { 
                        ticks: { color: '#94a3b8', font: { size: 10 } }, 
                        grid: { display: false } 
                    }
                }
            };
            
            const doughnutChartOptions = {
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#94a3b8',
                            font: { size: 12 },
                            boxWidth: 12,
                            padding: 15
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1e293b', 
                        titleColor: '#f472b6',
                        bodyColor: '#e2e8f0',
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1,
                        borderRadius: 6,
                        padding: 10,
                    }
                },
                cutout: '60%',
                onClick: (evt, elements) => {
                    if (elements.length > 0) {
                        const chart = elements[0].chart;
                        const index = elements[0].index;
                        const label = chart.data.labels[index];
                        window.location.hash = `#usulan&status=${label}`;
                    }
                },
            };

            const unsubParticipationChart = onSnapshot(collection(db, 'anggota'), async (anggotaSnap) => {
                const anggota = anggotaSnap.docs.map(d => d.data());

                if (participationChartInstance) participationChartInstance.destroy();
                const partCtx = document.getElementById('participationChart')?.getContext('2d');
                const orgsSnap = await getDocs(query(collection(db, 'organisasi'), orderBy("nama")));
                if (partCtx && !orgsSnap.empty) {
                    const orgs = orgsSnap.docs.map(d => d.data());
                    const participationData = orgs.map(org => ({
                        name: org.nama,
                        count: anggota.filter(a => a.organisasi === org.nama).length
                    })).sort((a,b) => a.count - b.count); // Sort ascending for horizontal chart
                    
                    const colorPalette = [
                        ['#ec4899', '#f472b6'], ['#8b5cf6', '#a78bfa'], ['#3b82f6', '#60a5fa'],
                        ['#14b8a6', '#2dd4bf'], ['#84cc16', '#a3e635'], ['#f59e0b', '#fbbf24']
                    ];

                    participationChartInstance = new Chart(partCtx, {
                        type: 'bar',
                        data: {
                            labels: participationData.map(p => p.name),
                            datasets: [{
                                label: 'Jumlah Anggota',
                                data: participationData.map(p => p.count),
                                backgroundColor: (context) => {
                                    const chart = context.chart;
                                    const {ctx, chartArea} = chart;
                                    if (!chartArea) return null;
                                    
                                    const gradient = ctx.createLinearGradient(chartArea.left, 0, chartArea.right, 0);
                                    const colors = colorPalette[context.dataIndex % colorPalette.length];
                                    gradient.addColorStop(0, colors[0]);
                                    gradient.addColorStop(1, colors[1]);
                                    return gradient;
                                },
                                borderWidth: 0,
                                borderRadius: 5,
                                barPercentage: 0.7,
                                categoryPercentage: 0.8,
                            }]
                        },
                        options: horizontalBarChartOptions
                    });
                }
            }, (error) => {
                console.error("Error getting anggota for chart:", error);
                const chartContainer = document.getElementById('participationChart')?.parentElement;
                if (chartContainer) {
                    chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-center text-slate-400"><p>Gagal memuat data grafik anggota.<br>Pastikan aturan keamanan Firebase mengizinkan akses baca.</p></div>`;
                }
            });

            const unsubProposalStatusChart = onSnapshot(collection(db, 'usulanKegiatan'), (snapshot) => {
                if (proposalStatusChartInstance) proposalStatusChartInstance.destroy();
                const statusCtx = document.getElementById('proposalStatusChart')?.getContext('2d');
                if(statusCtx) {
                    const statusCounts = { 'Diajukan': 0, 'Diverifikasi': 0, 'Disetujui': 0, 'Ditolak': 0 };
                    snapshot.forEach(doc => {
                        const status = doc.data().status;
                        if(status in statusCounts) {
                            statusCounts[status]++;
                        }
                    });

                    proposalStatusChartInstance = new Chart(statusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(statusCounts),
                            datasets: [{
                                data: Object.values(statusCounts),
                                backgroundColor: ['#fbbf24', '#38bdf8', '#4ade80', '#f472b6'],
                                hoverBackgroundColor: ['#f59e0b', '#0ea5e9', '#22c55e', '#ec4899'],
                                borderColor: '#1e293b',
                                borderWidth: 4,
                            }]
                        },
                        options: doughnutChartOptions
                    });
                }
            }, (error) => {
                console.error("Error getting usulan for chart:", error);
                const chartContainer = document.getElementById('proposalStatusChart')?.parentElement;
                if (chartContainer) {
                    chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-center text-slate-400"><p>Gagal memuat data grafik usulan.<br>Pastikan aturan keamanan Firebase mengizinkan akses baca.</p></div>`;
                }
            });

            activeListeners.push(unsubPengurus, unsubOrganisasi, unsubUsulan, unsubKegiatan, unsubParticipationChart, unsubProposalStatusChart);
        };
        
        // ===================================================================================
        // ROUTER & APP INITIALIZATION
        // ===================================================================================
        const appRoutes = {
            'dashboard': { title: 'Dashboard', render: renderDashboard, isDefault: true, subtitle: 'Selamat Datang' },
            'pengurus': { title: 'Manajemen Pengurus', render: (params) => renderCardPageFor('pengurus', params) },
            'organisasi': { title: 'Manajemen Organisasi', render: (params) => renderCardPageFor('organisasi', params) },
            'usulan': { title: 'Usulan Kegiatan', render: (params) => renderCardPageFor('usulan', params) },
            'dokumentasi': { title: 'Manajemen Dokumentasi', render: (params) => renderCardPageFor('dokumentasi', params) },
            'kegiatan': { title: 'Manajemen Kegiatan', render: (params) => renderCardPageFor('kegiatan', params) },
            'pengaturan': { title: 'Pengaturan', render: () => {
                mainContent.innerHTML = `
                    <div class="max-w-xl mx-auto">
                        <div class="card-base p-6 rounded-2xl">
                            <h2 class="text-xl sm:text-2xl font-bold mb-2">Pengaturan Aplikasi</h2>
                            <p class="text-slate-400 text-sm sm:text-base">Pengaturan umum untuk aplikasi SiMANJA GOW.</p>
                        </div>
                    </div>
                `;
            }},
        };

        const renderSidebar = (role) => {
            const allMenus = [
                { href: '#dashboard', icon: 'fa-home', text: 'Dashboard', roles: ['admin', 'organisasi', 'publik'] },
                { href: '#pengurus', icon: 'fa-user-tie', text: 'Pengurus', roles: ['admin', 'organisasi', 'publik'] },
                { href: '#organisasi', icon: 'fa-sitemap', text: 'Organisasi', roles: ['admin', 'organisasi', 'publik'] },
                { href: '#usulan', icon: 'fa-lightbulb', text: 'Usulan Kegiatan', roles: ['admin', 'organisasi'] },
                { href: '#dokumentasi', icon: 'fa-file-alt', text: 'Dokumentasi', roles: ['admin', 'organisasi'] },
                { href: '#kegiatan', icon: 'fa-calendar-alt', text: 'Kegiatan', roles: ['admin', 'organisasi', 'publik'] },
                { type: 'divider', roles: ['admin'] },
                { href: '#pengaturan', icon: 'fa-cog', text: 'Pengaturan', roles: ['admin'] },
            ];

            let menuHtml = '';
            allMenus.forEach(menu => {
                if (menu.roles.includes(role)) {
                    if (menu.type === 'divider') {
                        menuHtml += `<div class="border-t border-slate-700 my-4"></div>`;
                    } else {
                        menuHtml += `<a href="${menu.href}" class="menu-item group flex items-center px-3 py-2.5 rounded-lg text-sm font-medium"><i class="fas ${menu.icon} mr-3 w-4 text-center"></i><span>${menu.text}</span></a>`;
                    }
                }
            });
            sidebarNav.innerHTML = menuHtml;
        };

        const navigate = (hash) => {
            activeListeners.forEach(unsub => unsub());
            activeListeners = [];

            const hashParts = hash.substring(1).split('&');
            const routeName = hashParts[0] || 'dashboard';
            const params = new URLSearchParams(hashParts.slice(1).join('&'));
            const route = appRoutes[routeName] || appRoutes.dashboard;
            
            const openSidebarBtn = document.getElementById('openSidebar');
            const currentBackBtn = document.getElementById('back-to-dashboard-btn');
            if(currentBackBtn) currentBackBtn.remove();
            
            if (!route.isDefault) {
                openSidebarBtn.style.display = 'none';
                const backButton = document.createElement('a');
                backButton.href = '#dashboard';
                backButton.id = 'back-to-dashboard-btn';
                backButton.className = 'text-white text-xl mr-2';
                backButton.innerHTML = `<i class="fas fa-arrow-left"></i>`;
                headerContent.querySelector('.flex.items-center.space-x-3').prepend(backButton);
            } else {
                    openSidebarBtn.style.display = 'block';
            }
            headerTitleContainer.innerHTML = `<h2 class="text-lg sm:text-xl font-bold">${route.title}</h2><p class="text-xs text-white/80">${route.subtitle || ''}</p>`;

            route.render(params);
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.toggle('active', item.getAttribute('href') === `#${routeName}`);
            });
            if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full');
        };

        document.body.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            e.stopPropagation();
            const { action, id, collection, name } = target.dataset;
            
            const [actionType, page, subAction] = action.split('-');
            
            if (actionType === 'delete') {
                deleteData(collection, id, name);
            } else if (actionType === 'add' || actionType === 'edit') {
                createFormModalFor(page, id);
            } else if (actionType === 'view') {
                 viewDetail(page, id);
            } else if (actionType === 'manage') {
                if (page === 'organisasi') manageOrganisasi(id);
            } else if (actionType === 'approve') {
                if (page === 'usulan') updateUsulanStatus(id, 'Disetujui');
            } else if (actionType === 'reject') {
                if (page === 'usulan') showRejectReasonModal(id);
            } else if (actionType === 'verify') {
                if (page === 'usulan') updateUsulanStatus(id, 'Diverifikasi');
            } else if (actionType === 'download') {
                 if (page === 'dokumentasi') {
                    const downloadDokumen = async (id) => {
                        try {
                            const docSnap = await getDoc(doc(db, 'dokumentasi', id));
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                if (data.file && data.fileName) {
                                    const link = document.createElement('a');
                                    link.href = data.file;
                                    link.download = data.fileName;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                    showNotification('Unduhan dimulai...');
                                } else {
                                    showNotification('File tidak tersedia untuk diunduh.', true);
                                }
                            }
                        } catch (error) {
                            console.error("Gagal mengunduh file:", error);
                            showNotification('Gagal mengunduh file.', true);
                        }
                    };
                    downloadDokumen(id);
                }
            } else if (actionType === 'export') {
                if (page === 'pengurus') exportPengurusToPDF();
                else if (page === 'organisasi') exportAllOrganisasiToPDF();
                else if (page === 'kegiatan') exportKegiatanToPDF();
                else if (page === 'usulan' && subAction === 'excel') exportUsulanToExcel();
                else if (page === 'usulan' && subAction === 'pdf') exportUsulanToPDF();
                else if (page === 'spesifik') exportSpesifikOrganisasiToPDF(name);
            }
        });
        
        document.body.addEventListener('click', (e) => {
             const navLink = e.target.closest('a[href^="#"]');
             if (navLink && !navLink.closest('[data-action]')) {
                 e.preventDefault();
                 window.location.hash = navLink.getAttribute('href');
             }
        });

        document.getElementById('openSidebar').onclick = () => document.getElementById('sidebar').classList.remove('-translate-x-full');
        document.getElementById('closeSidebar').onclick = () => document.getElementById('sidebar').classList.add('-translate-x-full');

        window.onhashchange = () => {
            navigate(window.location.hash);
        };
        
        // Initial check, don't navigate yet, just let onAuthStateChanged handle it
        // navigate(window.location.hash || '#dashboard');
        
        // Splash Screen Logic
        window.addEventListener('load', () => {
            const splashScreen = document.getElementById('splash-screen');
            if (splashScreen) {
                setTimeout(() => {
                    splashScreen.classList.add('opacity-0');
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                    }, 1000); // Matches the transition duration
                }, 3500); // Splash screen visible for 3.5 seconds
            }
        });
    </script>
</body>
</html>


